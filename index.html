<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L ç¾ç”²è¨ˆç®—æ©Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="logo.jpg">

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --sub-text: #8D6E63; --brown: #8D7B6F; --radius: 16px; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px 20px 50px; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        h1 { text-align: center; margin: 0; letter-spacing: 1px; text-transform: uppercase; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--sub-text); margin-bottom: 25px; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin: 30px 0 15px; }
        .btn-reset { display:block; margin: 20px auto; background: transparent; border: 1px solid var(--sub-text); color: var(--sub-text); padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 15px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: 0.2s; }
        .card.active { border-color: var(--sub-text); background: #FFFBF8; }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        
        .tabs { display: flex; background: #EBE5DF; border-radius: 50px; padding: 4px; margin-bottom: 30px; }
        .tab { flex: 1; text-align: center; padding: 10px 0; border-radius: 50px; font-weight: bold; color: #9E9E9E; cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--card); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .stepper { display: flex; gap: 10px; background: #F5F5F5; padding: 4px; border-radius: 20px; align-items: center; }
        .btn-step { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .total-box { background: var(--brown); color: white; border-radius: 20px; padding: 25px; margin-top: 40px; text-align: center; box-shadow: 0 10px 30px rgba(141, 123, 111, 0.3); }
        .price-big { font-size: 3rem; font-weight: 800; margin: 5px 0 20px; line-height: 1; }
        .detail-list { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: left; min-height: 100px; font-size: 0.9rem; }
        .detail-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 5px; }
        .btn-copy { width: 100%; background: white; color: var(--brown); border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; margin-top: 20px; }
        .switch { position: relative; width: 50px; height: 28px; }
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--sub-text); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 99; display: flex; justify-content: center; align-items: center; color: var(--sub-text); font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">è®€å–è¨­å®šæª”...</div>

    <header>
        <h1>Fairy. L</h1>
        <div class="subtitle">ç¾ç”²è¨ˆç®—æ©Ÿ</div>
    </header>

    <div class="tabs">
        <div class="tab" id="role_manager" onclick="setRole('manager')">åº—é•·</div>
        <div class="tab active" id="role_artist" onclick="setRole('artist')">ç¾ç”²å¸«</div>
        <div class="tab" id="role_assistant" onclick="setRole('assistant')">åŠ©ç†</div>
    </div>

    <div id="area-services"></div>

    <div class="section-title">ä½ç½®</div>
    <div class="grid">
        <div class="card card-row" id="card_hand" onclick="togglePos('hand')">
            <span id="txt_hand">ğŸ–ï¸ æ‰‹éƒ¨</span>
            <span id="icon_hand" style="display:none; font-weight:bold">âœ”</span>
        </div>
        <div class="card card-row" id="card_foot" onclick="togglePos('foot')">
            <span id="txt_foot">ğŸ¦¶ è¶³éƒ¨</span>
            <span id="icon_foot" style="display:none; font-weight:bold">âœ”</span>
        </div>
    </div>

    <div class="section-title">å¸ç”²æœå‹™</div>
    <div class="grid" id="area-removes"></div>

    <div class="section-title">åŠ è³¼åŠå…¶ä»–</div>
    <div id="area-addons"></div>

    <div class="card card-row" style="margin-top:10px">
        <span style="font-weight:bold;">å…¶ä»–åŠ è³¼</span>
        <input type="number" id="custom_price" placeholder="è¼¸å…¥é‡‘é¡" oninput="calculate()" 
               style="border:none; background:#F5F5F5; padding:10px 15px; border-radius:10px; width:160px; text-align:right; font-size:1.1rem; outline:none; font-weight:bold; color:#4E342E;">
    </div>

    <div class="switch-row">
        <span style="font-weight:bold;" id="txt_birthday">ğŸ‚ ç•¶æœˆå£½æ˜Ÿå„ªæƒ </span>
        <label class="switch">
            <input type="checkbox" id="birthday" onchange="calculate()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="total-box">
        <div style="opacity:0.8">ç¸½è¨ˆ</div>
        <div class="price-big" id="display_total">$0</div>
        <div class="detail-list" id="detail_box"></div>
        <button class="btn-copy" onclick="copyQuote()">ğŸ“„ è¤‡è£½åƒ¹æ ¼æ˜ç´°</button>
    </div>

    <button class="btn-reset" onclick="resetAll()">æ¸…é™¤è¨ˆç®—</button>

    <script>
        // é è¨­å€¼
        let DATA = { 
            settings: { 
                birthday_discount: 0.9, 
                location_hand_name: "ğŸ–ï¸ æ‰‹éƒ¨", 
                location_foot_name: "ğŸ¦¶ è¶³éƒ¨", 
                location_foot_surcharge: 200 
            },
            categories: [], removals: [], add_ons: [] 
        };
        let ITEMS = {}; 
        let STATE = { role: 'artist', serviceId: null, removeId: null, addons: {}, hand: true, foot: false };

        window.onload = async () => {
            try {
                const res = await fetch('data.json?v=' + Date.now());
                if (res.ok) {
                    DATA = await res.json();
                    if (!DATA.settings) DATA.settings = {};
                    if (!DATA.settings.birthday_discount) DATA.settings.birthday_discount = 0.9;
                    if (!DATA.settings.location_foot_surcharge) DATA.settings.location_foot_surcharge = 200;
                }
                
                // å»ºç«‹ç´¢å¼•
                if (DATA.categories) DATA.categories.forEach(c => c.items.forEach(i => ITEMS[i.id] = i));
                if (DATA.removals) DATA.removals.forEach(i => ITEMS[i.id] = i);
                if (DATA.add_ons) DATA.add_ons.forEach(i => { ITEMS[i.id] = i; STATE.addons[i.id] = 0; });

                // é è¨­é¸å–
                if (DATA.categories && DATA.categories.length > 0) {
                     const firstValid = DATA.categories[0].items.find(i => getPrice(i) !== null);
                     if(firstValid) STATE.serviceId = firstValid.id;
                }
                if (DATA.removals && DATA.removals.length > 0) {
                     const firstValidRemove = DATA.removals.find(i => getPrice(i) !== null);
                     if(firstValidRemove) STATE.removeId = firstValidRemove.id;
                }

                renderAll();
                document.getElementById('loading').style.display = 'none';
            } catch(e) {
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª data.json æ ¼å¼");
                console.error(e);
                document.getElementById('loading').style.display = 'none';
            }
        };

        function renderAll() {
            renderServices();
            renderRemoves();
            renderAddons();
            updateGlobalUI(); 
            updateUI(); 
            calculate();
        }

        function updateGlobalUI() {
            const s = DATA.settings;
            document.getElementById('txt_hand').innerText = s.location_hand_name || "ğŸ–ï¸ æ‰‹éƒ¨";
            document.getElementById('txt_foot').innerText = `${s.location_foot_name || "ğŸ¦¶ è¶³éƒ¨"} (+$${s.location_foot_surcharge})`;
            
            const discountRate = s.birthday_discount || 0.9;
            let discountText = (discountRate * 10).toString().replace('.5', '.5') + "æŠ˜"; 
            if (discountRate === 1) discountText = "ç„¡æŠ˜æ‰£";
            document.getElementById('txt_birthday').innerText = `ğŸ‚ ç•¶æœˆå£½æ˜Ÿå„ªæƒ  (${discountText})`;
        }

        function renderServices() {
            const container = document.getElementById('area-services');
            let html = '';
            if (!DATA.categories) return;

            DATA.categories.forEach(cat => {
                const validItems = cat.items.filter(item => getPrice(item) !== null);
                if (validItems.length === 0) return;

                html += `<div class="section-title">${cat.title}</div><div class="grid">`;
                validItems.forEach(item => {
                    const price = getPrice(item);
                    const isActive = STATE.serviceId === item.id ? 'active' : '';
                    
                    let priceTxt = '';
                    if (Array.isArray(price)) {
                        priceTxt = `$${price[0]}`;
                    } else {
                        priceTxt = (price === 0) ? 'å…è²»' : `$${price}`;
                    }

                    html += `
                        <div class="card ${isActive}" onclick="selectService('${item.id}')">
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:0.85rem; color:#8D6E63">${priceTxt}</div>
                        </div>`;
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        function renderRemoves() {
            const container = document.getElementById('area-removes');
            if (!DATA.removals) return;
            container.innerHTML = DATA.removals.map(item => {
                const price = getPrice(item);
                if (price === null) return '';

                const isActive = STATE.removeId === item.id ? 'active' : '';
                const priceTxt = price === 0 ? 'å…è²»' : `$${price}`;
                
                return `
                    <div class="card ${isActive}" onclick="selectRemove('${item.id}')">
                        <div style="font-weight:bold">${item.name}</div>
                        <div style="font-size:0.85rem; color:#8D6E63">${priceTxt}</div>
                    </div>`;
            }).join('');
        }

        function renderAddons() {
            const container = document.getElementById('area-addons');
            if (!DATA.add_ons) return;
            container.innerHTML = DATA.add_ons.map(item => {
                const price = getPrice(item);
                if (price === null) return '';

                const priceTxt = (price === 0) ? 'å…è²»' : `$${price}`;

                return `
                    <div class="card card-row" style="margin-bottom:10px">
                        <div>
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:0.8rem; color:#8D6E63">${priceTxt} ${item.unit_desc||''}</div>
                        </div>
                        <div class="stepper">
                            <button class="btn-step" onclick="updateAddon('${item.id}', -1)">-</button>
                            <span style="font-weight:bold; width:20px; text-align:center">${STATE.addons[item.id]}</span>
                            <button class="btn-step" onclick="updateAddon('${item.id}', 1)">+</button>
                        </div>
                    </div>`;
            }).join('');
        }

        // --- ä¿®æ­£å¾Œçš„ getPrice å‡½å¼ ---
        function getPrice(item) {
            // æƒ…æ³ 1: JSON åªæœ‰ "price" (å–®æ•¸)ï¼Œè¡¨ç¤ºçµ±ä¸€åƒ¹æ ¼
            if (item.price !== undefined && item.price !== null) {
                return item.price;
            }
            
            // æƒ…æ³ 2: JSON æ˜¯ "prices" (è¤‡æ•¸)
            if (item.prices !== undefined) {
                if (typeof item.prices === 'number') return item.prices;
                // æ ¹æ“šè§’è‰²å›å‚³åƒ¹æ ¼
                return item.prices[STATE.role];
            }
            
            return null;
        }

        function setRole(role) {
            STATE.role = role;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`role_${role}`).classList.add('active');
            renderAll();
        }

        function selectService(id) { STATE.serviceId = id; renderServices(); calculate(); }
        function selectRemove(id) { STATE.removeId = id; renderRemoves(); calculate(); }
        function updateAddon(id, delta) {
            const newVal = STATE.addons[id] + delta;
            if (newVal >= 0) STATE.addons[id] = newVal;
            renderAddons(); calculate();
        }
        function togglePos(type) {
            if (type === 'hand') STATE.hand = !STATE.hand;
            if (type === 'foot') STATE.foot = !STATE.foot;
            updateUI(); calculate();
        }
        function updateUI() {
            document.getElementById('card_hand').classList.toggle('active', STATE.hand);
            document.getElementById('icon_hand').style.display = STATE.hand ? 'block' : 'none';
            document.getElementById('card_foot').classList.toggle('active', STATE.foot);
            document.getElementById('icon_foot').style.display = STATE.foot ? 'block' : 'none';
        }

        function resetAll() {
            if (DATA.categories && DATA.categories.length) {
                 const firstValid = DATA.categories[0].items.find(i => getPrice(i) !== null);
                 if(firstValid) STATE.serviceId = firstValid.id;
            }
            if (DATA.removals && DATA.removals.length) {
                 const firstValidRemove = DATA.removals.find(i => getPrice(i) !== null);
                 if(firstValidRemove) STATE.removeId = firstValidRemove.id;
            }

            for(let k in STATE.addons) STATE.addons[k] = 0;
            STATE.hand = true; STATE.foot = false;
            document.getElementById('custom_price').value = '';
            document.getElementById('birthday').checked = false;
            renderAll();
        }

        function calculate() {
            if (!STATE.serviceId) return;
            let total = 0;
            let details = '';
            
            // 1. ä¸»é …ç›®
            const item = ITEMS[STATE.serviceId];
            if (item) {
                const price = getPrice(item);
                if (price !== null) {
                    const surcharge = DATA.settings.location_foot_surcharge || 200;
                    
                    if (Array.isArray(price)) {
                        if (STATE.hand) { total += price[0]; details += row(item.name+' (æ‰‹)', price[0]); }
                        if (STATE.foot) { total += price[1]; details += row(item.name+' (è¶³)', price[1]); }
                    } else {
                        if (STATE.hand) { total += price; details += row(item.name+' (æ‰‹)', price); }
                        if (STATE.foot) { total += (price + surcharge); details += row(item.name+' (è¶³)', price + surcharge); }
                    }
                }
            }

            // 2. å¸ç”²
            const remove = ITEMS[STATE.removeId];
            if (remove) {
                const removePrice = getPrice(remove);
                if (removePrice !== null) {
                     total += removePrice; 
                     details += row('å¸ç”²: ' + remove.name, removePrice); 
                }
            }

            // 3. åŠ è³¼
            for (let id in STATE.addons) {
                if (STATE.addons[id] > 0) {
                    const add = ITEMS[id];
                    const p = getPrice(add);
                    if (p !== null) {
                        total += p * STATE.addons[id];
                        details += row(`${add.name} x${STATE.addons[id]}`, p * STATE.addons[id]);
                    }
                }
            }

            // 4. è‡ªè¨‚
            const custom = parseInt(document.getElementById('custom_price').value) || 0;
            if (custom > 0) { total += custom; details += row('å…¶ä»–åŠ è³¼', custom); }

            // 5. å£½æ˜Ÿå„ªæƒ 
            if (document.getElementById('birthday').checked) {
                const rate = DATA.settings.birthday_discount || 0.9;
                let originalTotal = total;
                total = Math.floor(total * rate);
                let saved = originalTotal - total;
                details += `<div class="detail-item" style="color:#FFCC80"><span>ğŸ‚ å£½æ˜Ÿå„ªæƒ </span><span>-$${saved}</span></div>`;
            }

            document.getElementById('display_total').innerText = `$${total}`;
            document.getElementById('detail_box').innerHTML = details || '<div style="text-align:center; opacity:0.5">å°šæœªé¸æ“‡é …ç›®</div>';
        }

        function row(name, money) { 
            return `<div class="detail-item"><span>${name}</span><span>$${money}</span></div>`; 
        }

        function copyQuote() {
            const roleName = {'manager':'åº—é•·', 'artist':'ç¾ç”²å¸«', 'assistant':'åŠ©ç†'}[STATE.role];
            const time = new Date().toLocaleDateString();
            let text = `ã€Fairy. L ç¾ç”²å ±åƒ¹å–®ã€‘\nğŸ“… æ—¥æœŸï¼š${time}\nğŸ‘¤ æœå‹™äººå“¡ï¼š${roleName}\n----------------------\n`;
            document.querySelectorAll('.detail-item').forEach(el => {
                const spans = el.querySelectorAll('span');
                text += `${spans[0].innerText} ... ${spans[1].innerText}\n`;
            });
            text += `----------------------\nğŸ’° ç¸½è¨ˆï¼š${document.getElementById('display_total').innerText}\n\nï¼Šæé†’ï¼šæœ¬åº—ä½œå“äº«æœ‰ä¸€é€±ä¿å›º`;
            navigator.clipboard.writeText(text).then(() => alert("âœ… å·²è¤‡è£½å ±åƒ¹å–®ï¼"));
        }
    </script>
</body>
</html>
