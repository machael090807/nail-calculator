<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L ç¾ç”²è¨ˆç®—æ©Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼è¨­å®š (CSS) --- */
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --sub-text: #8D6E63; --brown: #8D7B6F; --radius: 16px; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px 20px 50px; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        /* é€šç”¨å…ƒä»¶ */
        h1 { text-align: center; margin: 0; letter-spacing: 1px; text-transform: uppercase; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--sub-text); margin-bottom: 25px; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin: 30px 0 15px; }
        .btn-reset { display:block; margin: 20px auto; background: transparent; border: 1px solid var(--sub-text); color: var(--sub-text); padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        /* å¡ç‰‡èˆ‡æ ¼ç·šç³»çµ± */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: var(--card); border-radius: var(--radius); padding: 15px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: 0.2s; }
        .card.active { border-color: var(--sub-text); background: #FFFBF8; }
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        
        /* è§’è‰²åˆ‡æ› */
        .tabs { display: flex; background: #EBE5DF; border-radius: 50px; padding: 4px; margin-bottom: 30px; }
        .tab { flex: 1; text-align: center; padding: 10px 0; border-radius: 50px; font-weight: bold; color: #9E9E9E; cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--card); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* åŠ è³¼è¨ˆæ•¸å™¨æ¨£å¼ */
        .stepper { display: flex; gap: 10px; background: #F5F5F5; padding: 4px; border-radius: 20px; align-items: center; }
        .btn-step { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* ç¸½è¨ˆå€å¡Š */
        .total-box { background: var(--brown); color: white; border-radius: 20px; padding: 25px; margin-top: 40px; text-align: center; box-shadow: 0 10px 30px rgba(141, 123, 111, 0.3); }
        .price-big { font-size: 3rem; font-weight: 800; margin: 5px 0 20px; line-height: 1; }
        .detail-list { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: left; min-height: 100px; font-size: 0.9rem; }
        .detail-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 5px; }
        .btn-copy { width: 100%; background: white; color: var(--brown); border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* é–‹é—œ Switch */
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; margin-top: 20px; }
        .switch { position: relative; width: 50px; height: 28px; }
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--sub-text); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* è®€å–ç•«é¢ */
        #loading { position: fixed; inset: 0; background: var(--bg); z-index: 99; display: flex; justify-content: center; align-items: center; color: var(--sub-text); font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">è®€å–è³‡æ–™ä¸­...</div>

    <header>
        <h1>Fairy. L</h1>
        <div class="subtitle">ç¾ç”²è¨ˆç®—æ©Ÿ</div>
    </header>

    <div class="tabs">
        <div class="tab" id="role_manager" onclick="setRole('manager')">åº—é•·</div>
        <div class="tab active" id="role_artist" onclick="setRole('artist')">ç¾ç”²å¸«</div>
        <div class="tab" id="role_assistant" onclick="setRole('assistant')">åŠ©ç†</div>
    </div>

    <div id="area-services"></div>

    <div class="section-title">ä½ç½®</div>
    <div class="grid">
        <div class="card card-row" id="card_hand" onclick="togglePos('hand')">
            <span>ğŸ–ï¸ æ‰‹éƒ¨</span>
            <span id="icon_hand" style="display:none">âœ”</span>
        </div>
        <div class="card card-row" id="card_foot" onclick="togglePos('foot')">
            <span>ğŸ¦¶ è¶³éƒ¨ (+$200)</span>
            <span id="icon_foot" style="display:none">âœ”</span>
        </div>
    </div>

    <div class="section-title">å¸ç”²æœå‹™</div>
    <div class="grid" id="area-removes"></div>

    <div class="section-title">åŠ è³¼åŠå…¶ä»–</div>
    <div id="area-addons"></div>

    <div class="card card-row" style="margin-top:10px">
        <span>å…¶ä»–åŠ è³¼</span>
        <input type="number" id="custom_price" placeholder="è¼¸å…¥é‡‘é¡" oninput="calculate()" style="border:none; background:#F5F5F5; padding:5px; border-radius:5px; width:80px; text-align:right;">
    </div>

    <div class="switch-row">
        <span style="font-weight:bold;">ğŸ‚ ç•¶æœˆå£½æ˜Ÿå„ªæƒ  (9æŠ˜)</span>
        <label class="switch">
            <input type="checkbox" id="birthday" onchange="calculate()">
            <span class="slider"></span>
        </label>
    </div>

    <div class="total-box">
        <div style="opacity:0.8">ç¸½è¨ˆ</div>
        <div class="price-big" id="display_total">$0</div>
        <div class="detail-list" id="detail_box"></div>
        <button class="btn-copy" onclick="copyQuote()">ğŸ“„ è¤‡è£½åƒ¹æ ¼æ˜ç´°</button>
    </div>

    <button class="btn-reset" onclick="resetAll()">æ¸…é™¤è¨ˆç®—</button>

    <script>
        // --- è®Šæ•¸èˆ‡è¨­å®š ---
        let DATA = { categories: [], removals: [], add_ons: [] };
        let ITEMS = {}; // æ–¹ä¾¿ç”¨ ID æ‰¾è³‡æ–™
        let STATE = {
            role: 'artist',
            serviceId: null,
            removeId: null,
            addons: {}, // ç´€éŒ„åŠ è³¼æ•¸é‡ { id: count }
            hand: true,
            foot: false
        };

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            try {
                // æŠ“å–è³‡æ–™ï¼ŒåŠ æ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                const res = await fetch('data.json?v=' + Date.now());
                DATA = await res.json();
                
                // å»ºç«‹å¿«é€ŸæŸ¥è©¢è¡¨ (Mapping)
                DATA.categories.forEach(c => c.items.forEach(i => ITEMS[i.id] = i));
                DATA.removals.forEach(i => ITEMS[i.id] = i);
                DATA.add_ons.forEach(i => { ITEMS[i.id] = i; STATE.addons[i.id] = 0; });

                // é è¨­é¸å–ç¬¬ä¸€å€‹
                if(DATA.categories.length) STATE.serviceId = DATA.categories[0].items[0].id;
                if(DATA.removals.length) STATE.removeId = DATA.removals[0].id;

                renderAll();
                document.getElementById('loading').style.display = 'none';
            } catch(e) {
                alert("è®€å– data.json å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆ");
            }
        };

        // --- ç•«é¢æ¸²æŸ“ (Render) ---
        function renderAll() {
            renderServices();
            renderRemoves();
            renderAddons();
            updateUI(); // æ›´æ–°å‹¾é¸ç‹€æ…‹
            calculate();
        }

        // 1. ç”¢ç”Ÿæœå‹™åˆ—è¡¨ (å«éæ¿¾ç©ºåˆ†é¡åŠŸèƒ½)
        function renderServices() {
            const container = document.getElementById('area-services');
            let html = '';

            DATA.categories.forEach(cat => {
                // ç¯©é¸ï¼šåªæœ‰ã€Œæœ‰åƒ¹æ ¼ã€çš„é …ç›®æ‰é¡¯ç¤º
                const validItems = cat.items.filter(item => getPrice(item) !== null);
                
                // å¦‚æœé€™åˆ†é¡æ²’æ±è¥¿ï¼Œå°±è·³é
                if (validItems.length === 0) return;

                // æ¨£æ¿èªæ³•ï¼šå…ˆåŠ æ¨™é¡Œ
                html += `<div class="section-title">${cat.title}</div><div class="grid">`;
                
                // å†åŠ æ ¼å­
                validItems.forEach(item => {
                    const price = getPrice(item);
                    const isActive = STATE.serviceId === item.id ? 'active' : '';
                    const priceTxt = Array.isArray(price) ? `$${price[0]}` : `$${price}`;
                    
                    html += `
                        <div class="card ${isActive}" onclick="selectService('${item.id}')">
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:0.85rem; color:#8D6E63">${priceTxt}</div>
                        </div>`;
                });
                html += `</div>`; // é—œé–‰ grid
            });
            container.innerHTML = html;
        }

        // 2. ç”¢ç”Ÿå¸ç”²åˆ—è¡¨
        function renderRemoves() {
            const container = document.getElementById('area-removes');
            container.innerHTML = DATA.removals.map(item => {
                const price = getPrice(item);
                const isActive = STATE.removeId === item.id ? 'active' : '';
                const priceTxt = price === 0 ? 'å…è²»' : `$${price}`;
                return `
                    <div class="card ${isActive}" onclick="selectRemove('${item.id}')">
                        <div style="font-weight:bold">${item.name}</div>
                        <div style="font-size:0.85rem; color:#8D6E63">${priceTxt}</div>
                    </div>`;
            }).join('');
        }

        // 3. ç”¢ç”ŸåŠ è³¼åˆ—è¡¨
        function renderAddons() {
            const container = document.getElementById('area-addons');
            container.innerHTML = DATA.add_ons.map(item => {
                const price = getPrice(item);
                if (price === null) return ''; // æ²’åƒ¹æ ¼å°±ä¸é¡¯ç¤º
                
                return `
                    <div class="card card-row" style="margin-bottom:10px">
                        <div>
                            <div style="font-weight:bold">${item.name}</div>
                            <div style="font-size:0.8rem; color:#8D6E63">$${price} ${item.unit_desc||''}</div>
                        </div>
                        <div class="stepper">
                            <button class="btn-step" onclick="updateAddon('${item.id}', -1)">-</button>
                            <span style="font-weight:bold; width:20px; text-align:center">${STATE.addons[item.id]}</span>
                            <button class="btn-step" onclick="updateAddon('${item.id}', 1)">+</button>
                        </div>
                    </div>`;
            }).join('');
        }

        // --- äº’å‹•é‚è¼¯ ---
        function getPrice(item) {
            // å¦‚æœåƒ¹æ ¼æ˜¯æ•¸å­—ç›´æ¥å›å‚³ï¼Œå¦‚æœæ˜¯ç‰©ä»¶å‰‡æ ¹æ“šè§’è‰²å›å‚³
            if (typeof item.prices === 'number') return item.prices;
            return item.prices ? item.prices[STATE.role] : null;
        }

        function setRole(role) {
            STATE.role = role;
            // æ›´æ–°ä¸Šæ–¹åˆ†é æ¨£å¼
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`role_${role}`).classList.add('active');
            renderAll(); // åƒ¹æ ¼è®Šäº†ï¼Œå…¨éƒ¨é‡ç•«
        }

        function selectService(id) { STATE.serviceId = id; renderServices(); calculate(); }
        function selectRemove(id) { STATE.removeId = id; renderRemoves(); calculate(); }
        
        function updateAddon(id, delta) {
            const newVal = STATE.addons[id] + delta;
            if (newVal >= 0) STATE.addons[id] = newVal;
            renderAddons(); // åªéœ€è¦é‡ç•«åŠ è³¼å€
            calculate();
        }

        function togglePos(type) {
            if (type === 'hand') STATE.hand = !STATE.hand;
            if (type === 'foot') STATE.foot = !STATE.foot;
            updateUI();
            calculate();
        }

        function updateUI() {
            // æ§åˆ¶æ‰‹è¶³çš„å‹¾å‹¾é¡¯ç¤º (åŸæœ¬æ˜¯ Checkboxï¼Œç¾åœ¨æ”¹ç”¨ç´”æ¨£å¼æ¯”è¼ƒå¥½æ§åˆ¶)
            document.getElementById('card_hand').classList.toggle('active', STATE.hand);
            document.getElementById('icon_hand').style.display = STATE.hand ? 'block' : 'none';
            document.getElementById('card_foot').classList.toggle('active', STATE.foot);
            document.getElementById('icon_foot').style.display = STATE.foot ? 'block' : 'none';
        }

        function resetAll() {
            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            if(DATA.categories.length) STATE.serviceId = DATA.categories[0].items[0].id;
            if(DATA.removals.length) STATE.removeId = DATA.removals[0].id;
            for(let k in STATE.addons) STATE.addons[k] = 0;
            STATE.hand = true; STATE.foot = false;
            document.getElementById('custom_price').value = '';
            document.getElementById('birthday').checked = false;
            renderAll();
        }

        // --- è¨ˆç®—æ ¸å¿ƒ ---
        function calculate() {
            if (!STATE.serviceId) return;
            
            let total = 0;
            let details = '';
            
            // 1. ä¸»é …ç›®è¨ˆç®—
            const item = ITEMS[STATE.serviceId];
            const price = getPrice(item);
            
            if (Array.isArray(price)) {
                // åˆ†é–‹å®šåƒ¹ (åƒ¹æ ¼æ˜¯é™£åˆ— [æ‰‹, è¶³])
                if (STATE.hand) { total += price[0]; details += row(item.name+' (æ‰‹)', price[0]); }
                if (STATE.foot) { total += price[1]; details += row(item.name+' (è¶³)', price[1]); }
            } else {
                // å–®ä¸€å®šåƒ¹ (æ‰‹éƒ¨åŸåƒ¹ï¼Œè¶³éƒ¨+200)
                if (STATE.hand) { total += price; details += row(item.name+' (æ‰‹)', price); }
                if (STATE.foot) { total += (price + 200); details += row(item.name+' (è¶³)', price + 200); }
            }

            // 2. å¸ç”²
            const remove = ITEMS[STATE.removeId];
            const removePrice = getPrice(remove);
            if (removePrice > 0) {
                total += removePrice;
                details += row('å¸ç”²: ' + remove.name, removePrice);
            }

            // 3. åŠ è³¼
            for (let id in STATE.addons) {
                if (STATE.addons[id] > 0) {
                    const add = ITEMS[id];
                    const p = getPrice(add);
                    const sum = p * STATE.addons[id];
                    total += sum;
                    details += row(`${add.name} x${STATE.addons[id]}`, sum);
                }
            }

            // 4. è‡ªè¨‚é‡‘é¡
            const custom = parseInt(document.getElementById('custom_price').value) || 0;
            if (custom > 0) { total += custom; details += row('å…¶ä»–åŠ è³¼', custom); }

            // 5. å£½æ˜Ÿå„ªæƒ 
            if (document.getElementById('birthday').checked) {
                let discount = Math.round(total * 0.1); // 10% off
                total -= discount;
                details += `<div class="detail-item" style="color:#FFCC80"><span>ğŸ‚ å£½æ˜Ÿå„ªæƒ </span><span>-$${discount}</span></div>`;
            }

            document.getElementById('display_total').innerText = `$${total}`;
            document.getElementById('detail_box').innerHTML = details || '<div style="text-align:center; opacity:0.5">å°šæœªé¸æ“‡é …ç›®</div>';
        }

        function row(name, money) {
            return `<div class="detail-item"><span>${name}</span><span>$${money}</span></div>`;
        }

        function copyQuote() {
            const roleName = {'manager':'åº—é•·', 'artist':'ç¾ç”²å¸«', 'assistant':'åŠ©ç†'}[STATE.role];
            const time = new Date().toLocaleDateString();
            let text = `ã€Fairy. L ç¾ç”²å ±åƒ¹å–®ã€‘\nğŸ“… æ—¥æœŸï¼š${time}\nğŸ‘¤ æœå‹™äººå“¡ï¼š${roleName}\n----------------------\n`;
            
            // æŠ“å–æ˜ç´°æ–‡å­—
            document.querySelectorAll('.detail-item').forEach(el => {
                const spans = el.querySelectorAll('span');
                text += `${spans[0].innerText} ... ${spans[1].innerText}\n`;
            });
            
            text += `----------------------\nğŸ’° ç¸½è¨ˆï¼š${document.getElementById('display_total').innerText}\n\nï¼Šæé†’ï¼šæœ¬åº—ä½œå“äº«æœ‰ä¸€é€±ä¿å›º`;
            navigator.clipboard.writeText(text).then(() => alert("âœ… å·²è¤‡è£½å ±åƒ¹å–®ï¼"));
        }
    </script>
</body>
</html>
