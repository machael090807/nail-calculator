<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L å¾Œå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#F8F6F4; --card:#FFF; --text:#4E342E; --sub:#8D6E63; --main:#5D4037; --danger:#EF5350; --input:#F2F2F7; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--text); font-family:'Noto Sans TC',sans-serif; margin:0; padding-bottom:100px; font-size:16px; }
        
        /* --- RWD è‡ªé©æ‡‰è¨­å®š --- */
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 480px) {
            .app-header { padding: 12px 15px !important; }
            .card { padding: 15px !important; }
            .btn-icon { width: 36px !important; height: 36px !important; } /* æ‰‹æ©ŸæŒ‰éˆ•åŠ å¤§å¥½é» */
            h1 { font-size: 1.5rem !important; }
            .box { width: 90% !important; padding: 25px !important; }
        }

        /* ä»‹é¢å…ƒä»¶ */
        .app-header { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); padding:15px 20px; position:sticky; top:0; z-index:50; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
        .tabs-wrap { padding:10px 20px; position:sticky; top:60px; z-index:40; background:var(--bg); }
        .tabs { display:flex; background:#E0E0E0; padding:4px; border-radius:12px; }
        .tab { flex:1; text-align:center; padding:8px 0; border-radius:9px; font-size:0.9rem; font-weight:bold; color:#9E9E9E; cursor:pointer; transition:0.2s; }
        .tab.active { background:var(--card); color:var(--text); box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        
        .page { display:none; padding:10px 20px; animation:fadeIn 0.3s; max-width: 800px; margin: 0 auto; }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }

        .card { background:var(--card); border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:0 4px 20px rgba(109,76,65,0.05); position:relative; }
        .card-inner { background:#FAFAFA; border-radius:12px; padding:15px; margin-top:12px; border:1px solid #EEE; position:relative; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        label { display:block; margin:12px 0 6px; font-size:0.85rem; color:var(--sub); font-weight:bold; }
        input { width:100%; padding:12px; border:none; background:var(--input); border-radius:10px; font-size:1rem; color:var(--text); font-weight:500; }
        input:focus { background:#EAEAEA; }
        
        .btn { border:none; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .btn:active { transform:scale(0.96); }
        .btn-add { background:var(--main); color:#FFF; width:100%; padding:12px; margin-top:15px; }
        .btn-icon { width:32px; height:32px; border-radius:50%; background:#F5F5F5; color:#757575; font-size:1rem; cursor: pointer; }
        .btn-del { background:#FFEBEE; color:var(--danger); }
        .actions { position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5; }

        /* åƒ¹æ ¼ç¾¤çµ„ (RWD: å°è¢å¹•ç›´æ’ï¼Œå¤§è¢å¹•æ©«æ’) */
        .p-grp { display:flex; align-items:center; gap:10px; margin-top:8px; flex-wrap: wrap; }
        .p-item { flex: 1; min-width: 80px; display: flex; align-items: center; gap: 5px; }
        .p-lbl { font-size:0.8rem; color:#9E9E9E; font-weight:bold; white-space: nowrap; }

        /* åº•éƒ¨æµ®å‹•å€ */
        .bar { position:fixed; bottom:0; left:0; width:100%; background:#FFF; padding:15px 20px calc(15px + env(safe-area-inset-bottom)); box-shadow:0 -5px 20px rgba(0,0,0,0.08); z-index:90; display:flex; gap:12px; transform:translateY(100%); transition:0.3s; }
        .bar.show { transform:translateY(0); }
        .btn-save { flex:2; background:var(--main); color:#FFF; padding:14px; }
        .btn-cancel { flex:1; background:#F5F5F5; color:#757575; padding:14px; }

        /* ç™»å…¥èˆ‡è¦–çª— */
        #login, #gen { position:fixed; inset:0; background:var(--bg); z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.3s; }
        #gen { background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); display:none; }
        .box { background:#FFF; width:90%; max-width:350px; padding:30px; border-radius:24px; box-shadow:0 10px 40px rgba(0,0,0,0.1); text-align:center; position:relative; }
        
        select { width:100%; padding:12px 15px; border:none; background:var(--input); border-radius:10px; font-size:1rem; margin-bottom:15px; -webkit-appearance:none; text-align:center; text-align-last:center; background-image:url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234E342E%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat:no-repeat; background-position:right 15px center; background-size:10px; }

        /* å¯†ç¢¼çœ¼ç›æŒ‰éˆ•å®¹å™¨ */
        .pwd-wrap { position: relative; width: 100%; }
        .eye-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-size: 1.2rem; user-select: none; }
    </style>
</head>
<body>

    <div id="login">
        <h1 style="color:var(--main); margin-bottom:5px;">Fairy. L</h1>
        <p style="color:var(--sub); margin-bottom:30px;">å¾Œå°ç®¡ç†ç³»çµ±</p>
        <div class="box">
            <h3 style="margin-top:0">ç®¡ç†è€…ç™»å…¥</h3>
            <select id="user_list"><option disabled selected>è®€å–ä¸­...</option></select>
            
            <div class="pwd-wrap">
                <input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align:center; letter-spacing:2px; padding-right: 40px;">
                <span class="eye-btn" onclick="togglePwd()">ğŸ‘ï¸</span>
            </div>

            <button class="btn btn-add" id="btn-login" onclick="login()">ç™»å…¥</button>
            <p id="msg" style="color:var(--danger); font-size:0.85rem; height:20px; margin-top:10px; font-weight:bold;"></p>
        </div>
        <button onclick="el('gen').style.display='flex'" style="margin-top:50px; opacity:0; cursor:default;">.</button>
    </div>

    <div id="gen">
        <div class="box">
            <span onclick="el('gen').style.display='none'" style="position:absolute; top:15px; right:15px; cursor:pointer;">âœ•</span>
            <h3>ğŸ” ç”¢ç”Ÿé‡‘é‘°</h3>
            <input id="gt" placeholder="GitHub Token">
            <input id="gp" placeholder="è¨­å®šå¯†ç¢¼" style="margin-top:10px">
            <button class="btn btn-add" onclick="makeKey()">ç”¢ç”Ÿä¸¦è¤‡è£½</button>
            <div id="gr" style="display:none; margin-top:15px; background:#F5F5F5; padding:10px; word-break:break-all; font-family:monospace; font-size:0.8rem;"></div>
        </div>
    </div>

    <div id="admin" style="display:none;">
        <div class="app-header">
            <span style="font-weight:800; font-size:1.2rem;">å¾Œå°ç®¡ç†</span>
            <button class="btn" style="background:#EEE; color:var(--sub); padding:6px 12px;" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="tabs-wrap">
            <div class="tabs">
                <div class="tab active" onclick="tab('settings')">å…¨åŸŸ</div>
                <div class="tab" onclick="switchTab('categories')">èœå–®</div>
                <div class="tab" onclick="switchTab('others')">å…¶ä»–</div>
            </div>
        </div>

        <div id="p-settings" class="page active">
            <div class="card" style="padding-top:40px">
                <div class="section-header" style="position:absolute; top:15px; left:20px; font-weight:bold;">ğŸ‚ å„ªæƒ èˆ‡è¨­å®š</div>
                <label>å£½æ˜ŸæŠ˜æ‰£ (0.9 = 9æŠ˜)</label><input type="number" id="s_birth" step="0.01" oninput="updSet()">
                <label>æ‰‹éƒ¨åç¨±</label><input type="text" id="s_hand" oninput="updSet()">
                <label>è¶³éƒ¨åç¨±</label><input type="text" id="s_foot" oninput="updSet()">
                <label>è¶³éƒ¨åŠ åƒ¹ ($)</label><input type="number" id="s_price" oninput="updSet()">
            </div>
        </div>

        <div id="p-categories" class="page"><div id="list_cat"></div><button class="btn btn-add" onclick="addCat()">+ æ–°å¢åˆ†é¡</button></div>

        <div id="p-others" class="page">
            <div class="card"><div style="font-weight:bold; margin-bottom:10px">ğŸ’… å¸ç”²é …ç›®</div><div id="list_rm"></div><button class="btn" style="background:#EEE; width:100%; margin-top:10px" onclick="addSimple('removals')">æ–°å¢</button></div>
            <div class="card"><div style="font-weight:bold; margin-bottom:10px">â• åŠ è³¼é …ç›®</div><div id="list_add"></div><button class="btn" style="background:#EEE; width:100%; margin-top:10px" onclick="addSimple('add_ons')">æ–°å¢</button></div>
        </div>

        <div id="bar" class="bar">
            <button class="btn btn-cancel" onclick="cancel()">å¾©åŸ</button>
            <button class="btn btn-save" onclick="save()">å„²å­˜è®Šæ›´</button>
        </div>
    </div>

    <script>
        const CFG = { user: "machael090807", repo: "nail-calculator", path: "data.json" };
        let DATA={}, ORIG="", USERS=[], TOKEN="";
        const el = id => document.getElementById(id);

        // --- åˆå§‹åŒ– & è‡ªå‹•ç™»å…¥ ---
        window.onload = async () => {
            // 1. è®€å–ä½¿ç”¨è€…åˆ—è¡¨
            try { USERS = await (await fetch('admin_user.json?v='+Date.now())).json(); } catch(e){}
            el('user_list').innerHTML = USERS.map((u,i)=>`<option value="${i}">${u.name}</option>`).join('');

            // 2. æª¢æŸ¥æ˜¯å¦æœ‰å·²å„²å­˜çš„ Token (è‡ªå‹•ç™»å…¥)
            const savedToken = localStorage.getItem('fairy_admin_token');
            if(savedToken) {
                TOKEN = savedToken;
                loadData(true); // true ä»£è¡¨æ˜¯è‡ªå‹•ç™»å…¥ï¼Œéœé»˜æ¨¡å¼
            }
        };

        function togglePwd() {
            const p = el('pwd');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        async function login() {
            let u = USERS[el('user_list').value], p = el('pwd').value;
            if(!p) return el('msg').innerText = "è«‹è¼¸å…¥å¯†ç¢¼";
            
            el('msg').innerText = "é©—è­‰ä¸­...";
            el('btn-login').disabled = true;

            // è§£å‡º Token (é€™æ­¥é‚„æ²’é©—è­‰æ­£ç¢ºæ€§)
            let t = xor(atob(u.cipher), p);
            TOKEN = t;

            // å˜—è©¦é€£ç·š (çœŸæ­£çš„é©—è­‰åœ¨é€™è£¡)
            loadData(false);
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('fairy_admin_token');
                location.reload();
            }
        }

        async function loadData(isAuto) {
            try {
                // ä½¿ç”¨ Token å˜—è©¦æŠ“å–è³‡æ–™
                let r = await fetch(`https://api.github.com/repos/${CFG.user}/${CFG.repo}/contents/${CFG.path}`, { 
                    headers:{'Authorization':`token ${TOKEN}`} 
                });

                // éŒ¯èª¤è™•ç†ï¼šå€åˆ†å¯†ç¢¼éŒ¯èª¤ (401) å’Œå…¶ä»–éŒ¯èª¤
                if(r.status === 401) throw new Error("å¯†ç¢¼éŒ¯èª¤");
                if(r.status === 404) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ (Repoè¨­å®šéŒ¯èª¤)");
                if(!r.ok) throw new Error("é€£ç·šå¤±æ•—");

                // é€£ç·šæˆåŠŸï¼šè§£æè³‡æ–™
                let j = await r.json();
                DATA = JSON.parse(decodeURIComponent(escape(atob(j.content))));
                DATA.sha = j.sha; 
                if(!DATA.settings) DATA.settings={};
                
                ORIG = JSON.stringify(DATA); // å‚™ä»½åŸå§‹è³‡æ–™
                
                // ç™»å…¥æˆåŠŸè™•ç†
                localStorage.setItem('fairy_admin_token', TOKEN); // è¨˜ä½ Token
                render();
                
                el('login').style.opacity=0; 
                setTimeout(()=> { 
                    el('login').style.display='none'; 
                    el('admin').style.display='block'; 
                }, 300);

            } catch(e) { 
                el('btn-login').disabled = false;
                if(isAuto) {
                    // è‡ªå‹•ç™»å…¥å¤±æ•— (å¯èƒ½æ˜¯ Token éæœŸ)ï¼Œå®‰éœåœ°æ¸…é™¤ç´€éŒ„
                    localStorage.removeItem('fairy_admin_token');
                } else {
                    // æ‰‹å‹•ç™»å…¥å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤
                    el('msg').innerText = e.message; 
                }
            }
        }

        // --- æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
        function render() {
            // 1. è¨­å®š
            el('s_birth').value = DATA.settings.birthday_discount||0.9;
            el('s_hand').value = DATA.settings.location_hand_name||"";
            el('s_foot').value = DATA.settings.location_foot_name||"";
            el('s_price').value = DATA.settings.location_foot_surcharge||200;

            // 2. èœå–® (Categories)
            el('list_cat').innerHTML = (DATA.categories||[]).map((c, i) => htmlCard(i, c.title, 'cat', 
                (c.items||[]).map((it, j) => htmlItem(i, j, it)).join('') + 
                `<button class="btn" style="background:#F5F5F5; width:100%; margin-top:10px" onclick="addItem(${i})">+ é …ç›®</button>`
            )).join('');

            // 3. å…¶ä»– (Removals & Addons)
            el('list_rm').innerHTML = (DATA.removals||[]).map((it, i) => htmlItem(null, i, it, 'rm')).join('');
            el('list_add').innerHTML = (DATA.add_ons||[]).map((it, i) => htmlItem(null, i, it, 'add')).join('');
        }

        // --- HTML ç”Ÿæˆè¼”åŠ© (DRY) ---
        function acts(type, pIdx, idx, len) {
            let up = idx>0 ? '' : 'visibility:hidden', dn = idx<len-1 ? '' : 'visibility:hidden';
            let fn = type==='cat' ? [`move('cat',${idx},-1)`, `move('cat',${idx},1)`, `del('cat',${idx})`] :
                     type==='item'? [`move('item',${idx},-1,${pIdx})`, `move('item',${idx},1,${pIdx})`, `del('item',${idx},${pIdx})`] :
                     [`move('${type}',${idx},-1)`, `move('${type}',${idx},1)`, `del('${type}',${idx})`];
            return `<div class="actions">
                <button class="btn btn-icon" style="${up}" onclick="${fn[0]}">â†‘</button>
                <button class="btn btn-icon" style="${dn}" onclick="${fn[1]}">â†“</button>
                <button class="btn btn-icon btn-del" onclick="${fn[2]}">âœ•</button>
            </div>`;
        }

        function htmlCard(idx, title, type, content) {
            return `<div class="card" style="padding-top:45px">
                ${acts(type, null, idx, DATA.categories.length)}
                <label style="margin-top:0">åˆ†é¡æ¨™é¡Œ</label>
                <input value="${title}" oninput="upd(this.value, 'categories', ${idx}, 'title')">
                <div style="margin-top:15px; padding-left:5px; border-left:3px solid #EEE;">${content}</div>
            </div>`;
        }

        function htmlItem(pIdx, idx, item, type='item') {
            let list = type==='item' ? DATA.categories[pIdx].items : (type==='rm' ? DATA.removals : DATA.add_ons);
            let p = item.prices, isObj = typeof p === 'object' && p !== null;
            let v = k => isObj ? (p[k]===null?'':p[k]) : (k==='manager'? (p||0) : (p||0)); 
            
            let priceHTML = '';
            if (type === 'add' && !isObj) {
                priceHTML = `<label>å–®åƒ¹</label><input type="number" value="${item.price||0}" oninput="upd(this.value, 'add_ons', ${idx}, 'price')">`;
            } else {
                priceHTML = `<div class="p-grp">
                    <div class="p-item"><span class="p-lbl">åº—é•·</span><input type="number" value="${v('manager')}" oninput="updP('${type}',${idx},${pIdx},'manager',this.value)"></div>
                    <div class="p-item"><span class="p-lbl">ç¾ç”²</span><input type="number" value="${v('artist')}" oninput="updP('${type}',${idx},${pIdx},'artist',this.value)"></div>
                    <div class="p-item"><span class="p-lbl">åŠ©ç†</span><input type="number" value="${v('assistant')}" oninput="updP('${type}',${idx},${pIdx},'assistant',this.value)"></div>
                </div>`;
            }

            let path = type==='item'?`categories',${pIdx},'items',${idx}` : (type==='rm'?`removals',${idx}`:`add_ons',${idx}`);
            
            return `<div class="card-inner" style="padding-top:40px">
                ${acts(type, pIdx, idx, list.length)}
                <label style="margin-top:0">åç¨±</label>
                <input value="${item.name}" oninput="upd(this.value, '${path}', 'name')">
                ${priceHTML}
            </div>`;
        }

        // --- è³‡æ–™æ“ä½œ ---
        function chk() { 
            let dirty = JSON.stringify(DATA) !== ORIG;
            el('bar').classList.toggle('show', dirty);
        }
        function cancel() { if(confirm("æ”¾æ£„ä¿®æ”¹ï¼Ÿ")) { DATA=JSON.parse(ORIG); render(); chk(); } }

        function upd(val, ...path) {
            let t = DATA; for(let i=0; i<path.length-1; i++) t = t[path[i]];
            t[path[path.length-1]] = val; chk();
        }
        function updSet() {
            DATA.settings = {
                birthday_discount: parseFloat(el('s_birth').value),
                location_hand_name: el('s_hand').value,
                location_foot_name: el('s_foot').value,
                location_foot_surcharge: parseInt(el('s_price').value)
            }; chk();
        }
        function updP(type, idx, pIdx, role, val) {
            let item = type==='item' ? DATA.categories[pIdx].items[idx] : (type==='rm'?DATA.removals[idx]:DATA.add_ons[idx]);
            if(!item.prices || typeof item.prices!=='object') item.prices = {manager:0,artist:0,assistant:0};
            item.prices[role] = val===''?null:parseInt(val); chk();
        }

        // é€šç”¨æ’åºèˆ‡åˆªé™¤
        function move(type, idx, dir, pIdx) {
            let arr = type==='cat'?DATA.categories : (type==='item'?DATA.categories[pIdx].items : (type==='rm'?DATA.removals:DATA.add_ons));
            let n = idx+dir;
            if(n>=0 && n<arr.length) { [arr[idx], arr[n]] = [arr[n], arr[idx]]; render(); chk(); }
        }
        function del(type, idx, pIdx) {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            let arr = type==='cat'?DATA.categories : (type==='item'?DATA.categories[pIdx].items : (type==='rm'?DATA.removals:DATA.add_ons));
            arr.splice(idx, 1); render(); chk();
        }

        function addCat() { DATA.categories.push({title:"æ–°åˆ†é¡", items:[]}); render(); chk(); }
        function addItem(cIdx) { DATA.categories[cIdx].items.push({id:'i'+Date.now(), name:"æ–°é …ç›®", prices:{manager:0,artist:0,assistant:0}}); render(); chk(); }
        function addSimple(key) { 
            let obj = key==='add_ons' ? {id:'a'+Date.now(), name:"åŠ è³¼", price:100} : {id:'r'+Date.now(), name:"å¸ç”²", prices:{manager:0,artist:0,assistant:0}};
            DATA[key].push(obj); render(); chk(); 
        }

        // å„²å­˜
        async function save() {
            let btn = document.querySelector('.btn-save'); 
            let oldTxt = btn.innerText;
            btn.innerText="â³ å„²å­˜ä¸­...";
            try {
                let body = { message:"Update", content:btoa(unescape(encodeURIComponent(JSON.stringify(DATA,null,2)))), sha:DATA.sha };
                let r = await fetch(`https://api.github.com/repos/${CFG.user}/${CFG.repo}/contents/${CFG.path}`, {
                    method:'PUT', headers:{'Authorization':`token ${TOKEN}`, 'Content-Type':'application/json'}, body:JSON.stringify(body)
                });
                if(r.ok) { 
                    let j=await r.json(); DATA.sha=j.content.sha; ORIG=JSON.stringify(DATA); chk(); 
                    alert("âœ… å„²å­˜æˆåŠŸï¼"); 
                } 
                else throw 1;
            } catch(e) { alert("âŒ å„²å­˜å¤±æ•—"); } finally { btn.innerText=oldTxt; }
        }

        function makeKey() {
            let t=el('gt').value, p=el('gp').value;
            if(!t||!p) return alert("è«‹å¡«å¯«");
            let c = btoa(xor(t, p)); el('gr').innerText=c; el('gr').style.display='block';
        }
        function xor(t, k) { let r=''; for(let i=0;i<t.length;i++) r+=String.fromCharCode(t.charCodeAt(i)^k.charCodeAt(i%k.length)); return r; }
        
        function tab(id) { switchTab(id); } // alias
        function switchTab(id) { 
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); 
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); 
            el('p-'+id).classList.add('active'); 
            // æ‰¾åˆ°å°æ‡‰çš„ tab æŒ‰éˆ•ä¸¦åŠ  active
            const tabs = document.querySelectorAll('.tab');
            if(id === 'settings') tabs[0].classList.add('active');
            if(id === 'categories') tabs[1].classList.add('active');
            if(id === 'others') tabs[2].classList.add('active');
        }
    </script>
</body>
</html>
