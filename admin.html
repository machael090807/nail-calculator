<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairy. L å¾Œå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --btn: #8D7B6F; --btn-hover: #6D5B53; --danger: #E57373; --input-bg: #F5F5F5; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px; margin: 0; padding-bottom: 80px; }
        
        /* é ‚éƒ¨å°èˆª */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; }
        .btn-config { background: white; border: 1px solid #D7CCC8; color: var(--text); padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }

        /* åˆ†é æŒ‰éˆ• */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { flex: 1; min-width: 80px; text-align: center; padding: 10px; background: #E0D8D4; border-radius: 10px; cursor: pointer; color: #795548; font-weight: bold; white-space: nowrap; transition: 0.2s; }
        .tab.active { background: var(--btn); color: white; transform: scale(1.02); }
        
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡† */
        .card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; }
        .section-header { font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        
        label { display: block; margin-top: 12px; font-size: 0.9rem; color: #8D6E63; font-weight: bold; margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; border: none; background: var(--input-bg); border-radius: 10px; font-size: 1rem; box-sizing: border-box; color: var(--text); outline: none; font-weight: 500; }
        input:focus { background: #FFF; box-shadow: 0 0 0 2px var(--btn); }
        
        .row { display: flex; gap: 10px; }
        .row input { flex: 1; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn-add { background: #81C784; color: white; width: 100%; margin-top: 10px; padding: 12px; }
        .btn-del { background: transparent; color: var(--danger); border: 1px solid var(--danger); font-size: 0.8rem; position: absolute; top: 20px; right: 20px; padding: 5px 10px; }
        
        /* åº•éƒ¨æµ®å‹•å„²å­˜æŒ‰éˆ• */
        .btn-save { background: var(--btn); color: white; width: 100%; padding: 16px; font-size: 1.1rem; position: fixed; bottom: 0; left: 0; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 50; }
        .btn-save:active { background: var(--btn-hover); }

        /* åƒ¹æ ¼è¼¸å…¥å€å¡Š */
        .price-group { background: #FAFAFA; padding: 12px; border-radius: 10px; margin-top: 8px; border: 1px dashed #E0E0E0; }
        .price-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .price-row:last-child { margin-bottom: 0; }
        .price-label { width: 50px; font-size: 0.85rem; color: #999; }

        /* --- ç™»å…¥è¦–çª— (Modal) --- */
        #login_modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; }
        .login-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: var(--text); }
        .login-desc { font-size: 0.9rem; color: #8D6E63; margin-bottom: 25px; }
        .btn-connect { background: var(--btn); color: white; width: 100%; padding: 12px; font-size: 1rem; border-radius: 50px; margin-top: 20px; box-shadow: 0 4px 10px rgba(141, 123, 111, 0.4); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login_modal">
        <div class="login-box">
            <div class="login-title">Fairy. L å¾Œå°</div>
            <div class="login-desc">è«‹é€£æ¥æ‚¨çš„ GitHub è³‡æ–™åº«</div>
            
            <div style="text-align:left">
                <label>GitHub Token (Personal Access Token)</label>
                <input type="password" id="gh_token" placeholder="ghp_xxxx...">
                
                <label>ä½¿ç”¨è€…åç¨± (Username)</label>
                <input type="text" id="gh_user" placeholder="machael090807">
                
                <label>å„²å­˜åº«åç¨± (Repo)</label>
                <input type="text" id="gh_repo" placeholder="nail-calculator">
                
                <input type="hidden" id="gh_path" value="data.json">
            </div>

            <button class="btn-connect" onclick="attemptLogin()">ğŸš€ é€£æ¥è³‡æ–™åº«</button>
            <div id="login_msg" style="margin-top:10px; font-size:0.9rem; color:#E57373;"></div>
        </div>
    </div>

    <header>
        <h1>å¾Œå°ç®¡ç†</h1>
        <button class="btn-config" onclick="openLoginModal()">âš™ï¸ è¨­å®šé€£ç·š</button>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tab_settings')">å…¨åŸŸè¨­å®š</div>
        <div class="tab" onclick="switchTab('tab_categories')">æœå‹™èœå–®</div>
        <div class="tab" onclick="switchTab('tab_others')">å¸ç”² & åŠ è³¼</div>
    </div>

    <div id="tab_settings" class="page active">
        <div class="card">
            <div class="section-header">ğŸ‚ å„ªæƒ èˆ‡å…¶ä»–</div>
            <label>ç•¶æœˆå£½æ˜ŸæŠ˜æ‰£ (0.9 = 9æŠ˜)</label>
            <input type="number" id="set_birthday" step="0.01" placeholder="0.9">
        </div>
        <div class="card">
            <div class="section-header">ğŸ“ ä½ç½®åŠ åƒ¹</div>
            <label>æ‰‹éƒ¨é¡¯ç¤ºåç¨±</label>
            <input type="text" id="set_hand_name" placeholder="ğŸ–ï¸ æ‰‹éƒ¨">
            <label>è¶³éƒ¨é¡¯ç¤ºåç¨±</label>
            <input type="text" id="set_foot_name" placeholder="ğŸ¦¶ è¶³éƒ¨">
            <label>è¶³éƒ¨åŠ åƒ¹é‡‘é¡ ($)</label>
            <input type="number" id="set_foot_price" placeholder="200">
        </div>
    </div>

    <div id="tab_categories" class="page">
        <div id="categories_container"></div>
        <button class="btn-add" onclick="addCategory()" style="margin-bottom:30px">+ æ–°å¢æœå‹™å¤§åˆ†é¡</button>
    </div>

    <div id="tab_others" class="page">
        <div class="section-header">
            <span>ğŸ’… å¸ç”²é …ç›®</span>
            <button class="btn-add" style="width:auto; padding:8px 15px; margin:0; font-size:0.9rem" onclick="addRemoval()">+ æ–°å¢</button>
        </div>
        <div id="removals_container"></div>

        <div class="section-header" style="margin-top:30px">
            <span>â• åŠ è³¼é …ç›®</span>
            <button class="btn-add" style="width:auto; padding:8px 15px; margin:0; font-size:0.9rem" onclick="addAddon()">+ æ–°å¢</button>
        </div>
        <div id="addons_container"></div>
    </div>

    <button class="btn-save" onclick="saveData()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒæ›´æ–°</button>

    <script>
        let DATA = { settings: {}, categories: [], removals: [], add_ons: [], sha: "" };

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // è‡ªå‹•å¡«å…¥è¨˜æ†¶çš„è¨­å®š
            if(localStorage.getItem('gh_token')) document.getElementById('gh_token').value = localStorage.getItem('gh_token');
            if(localStorage.getItem('gh_user')) document.getElementById('gh_user').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('gh_repo').value = localStorage.getItem('gh_repo');
            
            // å¦‚æœæœ‰è¨­å®šï¼Œå˜—è©¦è‡ªå‹•é€£ç·š
            if(document.getElementById('gh_token').value) {
                attemptLogin(true); // true = éœé»˜æ¨¡å¼ï¼Œä¸è·³ alert
            }
        };

        function openLoginModal() {
            document.getElementById('login_modal').classList.remove('hidden');
        }

        async function attemptLogin(silent = false) {
            const btn = document.querySelector('.btn-connect');
            const msg = document.getElementById('login_msg');
            
            // å„²å­˜è¨­å®šåˆ°æœ¬åœ°
            localStorage.setItem('gh_token', document.getElementById('gh_token').value);
            localStorage.setItem('gh_user', document.getElementById('gh_user').value);
            localStorage.setItem('gh_repo', document.getElementById('gh_repo').value);

            btn.innerText = "é€£ç·šä¸­...";
            msg.innerText = "";

            try {
                await loadData();
                // æˆåŠŸï¼šéš±è—è¦–çª—
                document.getElementById('login_modal').classList.add('hidden');
                if(!silent) alert("âœ… é€£ç·šæˆåŠŸï¼");
            } catch (e) {
                msg.innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æˆ–è¨­å®š";
                // å¤±æ•—å‰‡ä¿æŒè¦–çª—é–‹å•Ÿ
                document.getElementById('login_modal').classList.remove('hidden');
            } finally {
                btn.innerText = "ğŸš€ é€£æ¥è³‡æ–™åº«";
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- GitHub API è®€å– ---
        async function loadData() {
            const token = document.getElementById('gh_token').value;
            const user = document.getElementById('gh_user').value;
            const repo = document.getElementById('gh_repo').value;
            const path = document.getElementById('gh_path').value;

            if (!token) throw new Error("No Token");

            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            
            if (!res.ok) throw new Error("Network Error");
            
            const json = await res.json();
            const content = decodeURIComponent(escape(atob(json.content)));
            DATA = JSON.parse(content);
            DATA.sha = json.sha;

            // ç¢ºä¿è³‡æ–™çµæ§‹å®Œæ•´
            if (!DATA.settings) DATA.settings = {};
            renderAll();
        }

        // --- æ¸²æŸ“ç•«é¢ ---
        function renderAll() {
            // 1. Settings
            document.getElementById('set_birthday').value = DATA.settings.birthday_discount || 0.9;
            document.getElementById('set_hand_name').value = DATA.settings.location_hand_name || "ğŸ–ï¸ æ‰‹éƒ¨";
            document.getElementById('set_foot_name').value = DATA.settings.location_foot_name || "ğŸ¦¶ è¶³éƒ¨";
            document.getElementById('set_foot_price').value = DATA.settings.location_foot_surcharge || 200;

            // 2. Categories
            const catContainer = document.getElementById('categories_container');
            catContainer.innerHTML = '';
            (DATA.categories || []).forEach((cat, cIdx) => {
                let itemsHtml = '';
                cat.items.forEach((item, iIdx) => { itemsHtml += createItemHTML('cat', cIdx, iIdx, item); });

                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <button class="btn-del" onclick="delCategory(${cIdx})">åˆªé™¤åˆ†é¡</button>
                    <label>åˆ†é¡æ¨™é¡Œ</label>
                    <input type="text" value="${cat.title}" onchange="updateCatTitle(${cIdx}, this.value)" style="font-weight:bold; color:#4E342E; font-size:1.1rem">
                    <div style="margin-top:15px; padding-left:10px; border-left: 3px solid #EFEBE9;">
                        ${itemsHtml}
                        <button class="btn-add" style="background:#BCAAA4; margin-top:15px" onclick="addItem(${cIdx})">+ æ–°å¢é …ç›®</button>
                    </div>
                `;
                catContainer.appendChild(div);
            });

            // 3. Removals
            const rmContainer = document.getElementById('removals_container');
            rmContainer.innerHTML = '';
            (DATA.removals || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = createItemHTML('rm', null, idx, item);
                rmContainer.appendChild(div);
            });

            // 4. Add-ons
            const addContainer = document.getElementById('addons_container');
            addContainer.innerHTML = '';
            (DATA.add_ons || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                let priceHtml = item.prices && typeof item.prices === 'object' 
                    ? getPriceInputsHTML('addon', null, idx, item.prices)
                    : `<label>å–®åƒ¹</label><input type="number" value="${item.price||0}" onchange="updateAddonSimplePrice(${idx}, this.value)">`;

                div.innerHTML = `
                    <button class="btn-del" onclick="delAddon(${idx})">åˆªé™¤</button>
                    <label>é …ç›®åç¨±</label>
                    <input type="text" value="${item.name}" onchange="DATA.add_ons[${idx}].name = this.value">
                    <div class="row">
                        <div><label>å–®ä½</label><input type="text" value="${item.unit_desc||''}" onchange="DATA.add_ons[${idx}].unit_desc = this.value"></div>
                    </div>
                    ${priceHtml}
                `;
                addContainer.appendChild(div);
            });
        }

        // --- Helper: ç”¢ç”Ÿé …ç›® HTML ---
        function createItemHTML(type, cIdx, iIdx, item) {
            let prices = item.prices;
            let delFunc = type === 'cat' ? `delItem(${cIdx}, ${iIdx})` : `delRemoval(${iIdx})`;
            let nameChange = type === 'cat' ? `DATA.categories[${cIdx}].items[${iIdx}].name = this.value` : `DATA.removals[${iIdx}].name = this.value`;
            
            return `
                <div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:12px; position:relative; border:1px solid #EEE;">
                    <button class="btn-del" style="top:10px; right:10px; padding:2px 8px" onclick="${delFunc}">x</button>
                    <label style="margin-top:0">åç¨±</label>
                    <input type="text" value="${item.name}" onchange="${nameChange}" style="background:#FAFAFA">
                    ${getPriceInputsHTML(type, cIdx, iIdx, prices)}
                </div>
            `;
        }

        function getPriceInputsHTML(type, cIdx, iIdx, prices) {
            let p = prices;
            if (typeof p !== 'object' || p === null) {
                let val = (typeof p === 'number') ? p : '';
                p = { manager: val, artist: val, assistant: val };
            }
            
            const update = (role) => {
                if (type === 'cat') return `updatePrice('cat', ${cIdx}, ${iIdx}, '${role}', this.value)`;
                if (type === 'rm') return `updatePrice('rm', null, ${iIdx}, '${role}', this.value)`;
                if (type === 'addon') return `updatePrice('addon', null, ${iIdx}, '${role}', this.value)`;
            };
            
            const val = (v) => Array.isArray(v) ? v[0] : (v === null ? '' : v);

            return `
                <div class="price-group">
                    <div class="price-row"><span class="price-label">åº—é•·</span><input type="number" placeholder="ç„¡" value="${val(p.manager)}" onchange="${update('manager')}"></div>
                    <div class="price-row"><span class="price-label">ç¾ç”²å¸«</span><input type="number" placeholder="ç„¡" value="${val(p.artist)}" onchange="${update('artist')}"></div>
                    <div class="price-row"><span class="price-label">åŠ©ç†</span><input type="number" placeholder="ç„¡" value="${val(p.assistant)}" onchange="${update('assistant')}"></div>
                </div>
            `;
        }

        // --- è³‡æ–™æ›´æ–° ---
        function updateCatTitle(cIdx, val) { DATA.categories[cIdx].title = val; }
        function updatePrice(type, cIdx, iIdx, role, val) {
            let target;
            if (type === 'cat') target = DATA.categories[cIdx].items[iIdx];
            else if (type === 'rm') target = DATA.removals[iIdx];
            else if (type === 'addon') target = DATA.add_ons[iIdx];

            if (!target.prices || typeof target.prices !== 'object') target.prices = { manager:null, artist:null, assistant:null };
            target.prices[role] = val === '' ? null : parseInt(val);
        }
        function updateAddonSimplePrice(idx, val) {
            DATA.add_ons[idx].price = parseInt(val) || 0;
            delete DATA.add_ons[idx].prices;
        }

        // --- æ–°å¢ / åˆªé™¤ ---
        function addCategory() { DATA.categories.push({ title: "æ–°åˆ†é¡", items: [] }); renderAll(); }
        function delCategory(idx) { if(confirm("åˆªé™¤æ­¤åˆ†é¡ï¼Ÿ")) { DATA.categories.splice(idx, 1); renderAll(); } }
        function addItem(cIdx) { DATA.categories[cIdx].items.push({ id: 'i'+Date.now(), name: "æ–°é …ç›®", prices: { manager:0, artist:0, assistant:0 } }); renderAll(); }
        function delItem(cIdx, iIdx) { DATA.categories[cIdx].items.splice(iIdx, 1); renderAll(); }
        function addRemoval() { DATA.removals.push({ id: 'r'+Date.now(), name: "æ–°å¸ç”²", prices: { manager:0, artist:0, assistant:0 } }); renderAll(); }
        function delRemoval(idx) { DATA.removals.splice(idx, 1); renderAll(); }
        function addAddon() { DATA.add_ons.push({ id: 'a'+Date.now(), name: "æ–°åŠ è³¼", price: 100 }); renderAll(); }
        function delAddon(idx) { DATA.add_ons.splice(idx, 1); renderAll(); }

        // --- å­˜æª” ---
        async function saveData() {
            DATA.settings.birthday_discount = parseFloat(document.getElementById('set_birthday').value);
            DATA.settings.location_hand_name = document.getElementById('set_hand_name').value;
            DATA.settings.location_foot_name = document.getElementById('set_foot_name').value;
            DATA.settings.location_foot_surcharge = parseInt(document.getElementById('set_foot_price').value);

            const token = document.getElementById('gh_token').value;
            const user = document.getElementById('gh_user').value;
            const repo = document.getElementById('gh_repo').value;
            const path = document.getElementById('gh_path').value;

            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "â³ å„²å­˜ä¸­...";

            const content = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));
            const body = { message: "Update via Admin", content: content, sha: DATA.sha };

            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    const json = await res.json();
                    DATA.sha = json.content.sha;
                    alert("âœ… å„²å­˜æˆåŠŸï¼");
                } else throw new Error("Save Failed");
            } catch (e) {
                alert("âŒ å„²å­˜å¤±æ•—");
            } finally {
                btn.innerText = originalText;
            }
        }
    </script>
</body>
</html>
