<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L 後台管理</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* 全域設定：防止跑版的神奇語法 */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        :root { 
            --bg: #F6F1ED; 
            --card: #FFFFFF; 
            --text: #4E342E; 
            --accent: #8D6E63; 
            --danger: #d32f2f; 
            --gray: #f5f5f5;
            --border: #e0e0e0;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Noto Sans TC', sans-serif; 
            padding: 15px; 
            padding-bottom: 100px; /* 留給下方懸浮按鈕空間 */
            margin: 0;
        }

        h1 { text-align: center; margin: 10px 0 5px 0; font-size: 1.5rem; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--accent); margin-bottom: 20px; }
        
        /* 登入區 */
        #login-panel { 
            max-width: 400px; 
            margin: 20px auto; 
            background: var(--card); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            text-align: center; 
        }
        input[type="password"], input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            margin-top: 10px; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            font-size: 1rem; 
            background: var(--gray);
        }
        .btn-main { 
            background: var(--text); 
            color: white; 
            border: none; 
            padding: 12px 0; 
            border-radius: 50px; 
            font-size: 1rem; 
            margin-top: 20px; 
            cursor: pointer; 
            width: 100%; 
            font-weight: bold;
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }

        /* 編輯區容器 */
        #editor-panel { display: none; width: 100%; max-width: 600px; margin: 0 auto; }
        
        /* 卡片樣式 */
        .section-card { 
            background: var(--card); 
            border-radius: 16px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }

        /* 分類標題區 */
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--bg); 
            padding-bottom: 10px; 
            margin-bottom: 10px; 
            flex-wrap: wrap; /* 讓內容在小螢幕自動換行 */
            gap: 10px;
        }
        .cat-title-input { 
            font-size: 1.1rem; 
            font-weight: bold; 
            border: none; 
            background: transparent; 
            color: var(--text); 
            flex: 1; /* 佔滿剩餘空間 */
            min-width: 150px;
        }
        
        /* 按鈕群組 */
        .btn-group { display: flex; gap: 5px; }
        .btn-icon { 
            width: 32px; height: 32px; 
            border-radius: 8px; 
            border: none; 
            background: var(--gray); 
            color: #666; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; 
        }
        .btn-del { color: var(--danger); background: #ffebee; }
        .btn-icon:active { transform: scale(0.9); }

        /* 項目列表 */
        .item-row { 
            background: #fff;
            padding: 10px 0; 
            border-bottom: 1px dashed var(--border); 
        }
        .item-row:last-child { border-bottom: none; }
        
        /* 項目第一行：名稱 + 操作按鈕 */
        .row-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .name-input { 
            flex: 1; 
            padding: 8px 10px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-weight: bold; 
            background: #fff;
            font-size: 0.95rem;
        }
        
        /* 價格輸入區 (Grid 排版) */
        .price-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; /* 三等分 */
            gap: 8px; 
            background: var(--bg);
            padding: 10px;
            border-radius: 10px;
        }
        .price-col { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .price-label { 
            font-size: 0.75rem; 
            color: #888; 
            margin-bottom: 4px; 
        }
        .price-input { 
            width: 100%; 
            padding: 8px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            text-align: center; 
            background: #fff; 
            font-size: 1rem; 
            font-weight: bold;
            color: var(--text);
        }

        /* 底部操作按鈕 */
        .btn-add-item { 
            width: 100%; 
            padding: 12px; 
            background: #fcfcfc; 
            border: 2px dashed #ddd; 
            border-radius: 10px; 
            color: #888; 
            font-size: 0.9rem;
            margin-top: 5px; 
        }
        .btn-add-cat { 
            width: 100%; 
            padding: 15px; 
            background: transparent; 
            border: 2px dashed var(--accent); 
            border-radius: 16px; 
            color: var(--accent); 
            font-weight: bold; 
            margin-bottom: 30px; 
        }
        
        /* 懸浮儲存按鈕 (優化版) */
        #save-btn { 
            position: fixed; 
            bottom: 25px; 
            right: 20px; 
            background: var(--text); 
            color: white; 
            padding: 12px 25px; 
            border-radius: 50px; 
            border: none; 
            font-size: 1rem; 
            box-shadow: 0 4px 20px rgba(78, 52, 46, 0.4); 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: bold;
        }
        #save-btn:active { transform: scale(0.95); }

        details summary { cursor: pointer; list-style: none; outline: none; }
        details summary::-webkit-details-marker { display: none; } /* 隱藏預設箭頭 */
    </style>
</head>
<body>

    <h1>Fairy. L 後台管理系統</h1>
    <div class="subtitle">Fairy. L Pricing Editor</div>

    <div id="login-panel">
        <h3>管理者登入</h3>
        <input type="password" id="token-input" placeholder="輸入密碼 (ghp_...)">
        <button class="btn-main" onclick="login()">登入</button>
    </div>

    <div id="editor-panel">
        <div id="categories-area"></div>
        <button class="btn-add-cat" onclick="addCategory()">＋ 新增服務分類</button>
        
        <div class="subtitle">———— 其他設定 ————</div>
        <div id="addons-area"></div>

        <button id="save-btn" onclick="saveToGithub()">
            <i class="fas fa-save"></i> 儲存並發布
        </button>
    </div>

    <script>
        const REPO_CONFIG = {
            owner: 'machael090807',     
            repo: 'nail-calculator',    
            path: 'data.json'           
        };

        let currentData = null;
        let fileSha = null;
        let ghToken = null;

        window.onload = function() {
            const savedToken = localStorage.getItem('gh_token');
            if(savedToken) document.getElementById('token-input').value = savedToken;
        }

        async function login() {
            const inputToken = document.getElementById('token-input').value.trim();
            const btn = document.querySelector('#login-panel button');

            if(!inputToken) return alert("請輸入 Token");
            btn.innerText = '讀取中...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    headers: { 'Authorization': `token ${inputToken}` }
                });

                if(!response.ok) throw new Error('Token 無效或連線失敗');

                const data = await response.json();
                fileSha = data.sha; 
                const content = decodeURIComponent(escape(window.atob(data.content)));
                currentData = JSON.parse(content);
                
                if(!currentData.categories) currentData.categories = [];
                if(!currentData.add_ons) currentData.add_ons = [];

                ghToken = inputToken;
                localStorage.setItem('gh_token', inputToken);

                renderEditor();
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('editor-panel').style.display = 'block';

            } catch (e) {
                alert('錯誤：' + e.message);
                btn.innerText = '登入';
                btn.disabled = false;
            }
        }

        function renderEditor() {
            renderCategories();
            renderAddons();
        }

        function renderCategories() {
            const container = document.getElementById('categories-area');
            container.innerHTML = '';

            currentData.categories.forEach((cat, catIdx) => {
                const card = document.createElement('div');
                card.className = 'section-card';
                
                let html = `
                    <div class="section-header">
                        <input type="text" class="cat-title-input" value="${cat.title}" onchange="updateCatTitle(${catIdx}, this.value)">
                        <div class="btn-group">
                            <button class="btn-icon" onclick="moveCategory(${catIdx}, -1)"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn-icon" onclick="moveCategory(${catIdx}, 1)"><i class="fas fa-arrow-down"></i></button>
                            <button class="btn-icon btn-del" onclick="deleteCategory(${catIdx})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="item-list">
                `;

                cat.items.forEach((item, itemIdx) => {
                    const p = item.prices;
                    html += `
                        <div class="item-row">
                            <div class="row-top">
                                <input type="text" class="name-input" value="${item.name}" placeholder="項目名稱" 
                                    onchange="updateItemName(${catIdx}, ${itemIdx}, this.value)">
                                <div class="btn-group">
                                    <button class="btn-icon" onclick="moveItem(${catIdx}, ${itemIdx}, -1)"><i class="fas fa-arrow-up"></i></button>
                                    <button class="btn-icon" onclick="moveItem(${catIdx}, ${itemIdx}, 1)"><i class="fas fa-arrow-down"></i></button>
                                    <button class="btn-icon btn-del" onclick="deleteItem(${catIdx}, ${itemIdx})"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <div class="price-grid">
                                <div class="price-col">
                                    <span class="price-label">店長</span>
                                    <input type="number" class="price-input" value="${getPrice(p.manager)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'manager', this.value)">
                                </div>
                                <div class="price-col">
                                    <span class="price-label">美甲師</span>
                                    <input type="number" class="price-input" value="${getPrice(p.artist)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'artist', this.value)">
                                </div>
                                <div class="price-col">
                                    <span class="price-label">助理</span>
                                    <input type="number" class="price-input" value="${getPrice(p.assistant)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'assistant', this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div><button class="btn-add-item" onclick="addItem(${catIdx})">＋ 新增項目</button>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function renderAddons() {
            const container = document.getElementById('addons-area');
            container.innerHTML = '';
            
            const card = document.createElement('div');
            card.className = 'section-card';
            let html = `<div class="section-header"><b>加購與延甲設定</b></div>`;
            
            currentData.add_ons.forEach((item, idx) => {
                 let priceVal = typeof item.price === 'number' ? item.price : item.prices.manager;
                 html += `
                    <div class="item-row" style="flex-direction:row; align-items:center;">
                        <input type="text" class="name-input" value="${item.name}" disabled style="background:#eee; color:#888;">
                        <input type="number" class="price-input" style="width:100px; margin-left:10px;" value="${priceVal}" 
                            onchange="updateAddonPrice(${idx}, this.value)">
                    </div>
                 `;
            });
            html += `<p style="font-size:0.8rem; color:#888; text-align:center;">* 加購項目僅供修改金額</p>`;
            card.innerHTML = html;
            container.appendChild(card);
        }

        // --- CRUD 邏輯 (保持不變) ---
        function addCategory() {
            currentData.categories.push({ title: "新分類名稱", items: [] });
            renderCategories();
        }

        function deleteCategory(idx) {
            if(!confirm(`刪除「${currentData.categories[idx].title}」？`)) return;
            currentData.categories.splice(idx, 1);
            renderCategories();
        }

        function moveCategory(idx, dir) {
            if (idx + dir < 0 || idx + dir >= currentData.categories.length) return;
            [currentData.categories[idx], currentData.categories[idx + dir]] = [currentData.categories[idx + dir], currentData.categories[idx]];
            renderCategories();
        }

        function updateCatTitle(idx, val) { currentData.categories[idx].title = val; }

        function addItem(catIdx) {
            const newId = 'item_' + new Date().getTime();
            currentData.categories[catIdx].items.push({
                id: newId, name: "新項目", prices: { manager: 0, artist: 0, assistant: 0 }
            });
            renderCategories();
        }

        function deleteItem(catIdx, itemIdx) {
            if(!confirm("刪除此項目？")) return;
            currentData.categories[catIdx].items.splice(itemIdx, 1);
            renderCategories();
        }

        function moveItem(catIdx, itemIdx, dir) {
            const items = currentData.categories[catIdx].items;
            if (itemIdx + dir < 0 || itemIdx + dir >= items.length) return;
            [items[itemIdx], items[itemIdx + dir]] = [items[itemIdx + dir], items[itemIdx]];
            renderCategories();
        }

        function updateItemName(catIdx, itemIdx, val) { currentData.categories[catIdx].items[itemIdx].name = val; }

        function updatePrice(catIdx, itemIdx, role, val) {
            const num = val === '' ? null : parseInt(val);
            const prices = currentData.categories[catIdx].items[itemIdx].prices;
            if (Array.isArray(prices[role])) {
                const diff = prices[role][1] - prices[role][0];
                prices[role] = [num, num + diff];
            } else {
                prices[role] = num;
            }
        }
        
        function getPrice(p) { return Array.isArray(p) ? p[0] : p; }

        function updateAddonPrice(idx, val) {
            const num = parseInt(val);
            const item = currentData.add_ons[idx];
            if(typeof item.price === 'number') { item.price = num; } 
            else { item.prices.manager = num; if(item.prices.artist) item.prices.artist = num; if(item.prices.assistant) item.prices.assistant = num; }
        }

        async function saveToGithub() {
            if(!confirm("確定儲存並發布？")) return;
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';
            btn.disabled = true;

            const jsonString = JSON.stringify(currentData, null, 4);
            const contentEncoded = window.btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: "Update via CMS Admin",
                content: contentEncoded,
                sha: fileSha
            };

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${ghToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if(!response.ok) throw new Error('上傳失敗');
                const resData = await response.json();
                fileSha = resData.content.sha;

                alert('✅ 發布成功！需等待1-2分鐘刷新頁面');
                btn.innerHTML = '<i class="fas fa-save"></i> 儲存並發布';
                btn.disabled = false;
            } catch (e) {
                alert('錯誤：' + e.message);
                btn.innerHTML = '<i class="fas fa-save"></i> 儲存並發布';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
