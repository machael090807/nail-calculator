<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L å¾Œå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --accent: #8D6E63; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px; }
        h1 { text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--accent); margin-bottom: 30px; }
        
        /* ç™»å…¥å€ */
        #login-panel { max-width: 400px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        input[type="password"], input[type="text"] { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--text); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 1rem; margin-top: 20px; cursor: pointer; width: 100%; }
        
        /* ç·¨è¼¯å€ */
        #editor-panel { display: none; max-width: 600px; margin: 0 auto; }
        .section-card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section-title { font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* é …ç›®æ¨£å¼ */
        .item-row { border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .item-row:last-child { border-bottom: none; margin-bottom: 0; }
        .label { font-size: 0.85rem; color: #888; margin-bottom: 4px; display: block; }
        .flex-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        input.price-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; background: #FAFAFA; }
        
        /* æ‡¸æµ®å„²å­˜æŒ‰éˆ• */
        #save-btn { position: fixed; bottom: 20px; right: 20px; width: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; }
        
        details summary { cursor: pointer; font-weight: bold; list-style: none; outline: none; }
        details[open] summary { margin-bottom: 15px; }
    </style>
</head>
<body>

    <h1>å¾Œå°ç®¡ç†ç³»çµ±</h1>
    <div class="subtitle">Fairy. L Pricing Editor</div>

    <div id="login-panel">
        <p>è«‹è¼¸å…¥ GitHub Token</p>
        <input type="password" id="token-input" placeholder="ghp_xxxxxxxxxxxx">
        <button onclick="login()">ç™»å…¥å¾Œå°</button>
        <div style="margin-top:10px; font-size:0.8rem; color:#999;">Token å°‡æš«å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­</div>
    </div>

    <div id="editor-panel">
        <div id="content-area"></div>
        <button id="save-btn" onclick="saveToGithub()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
    </div>

    <script>
        // è¨­å®šæ‚¨çš„ GitHub è³‡è¨Š
        const CONFIG = {
            owner: 'machael090807',     // æ‚¨çš„å¸³è™Ÿ
            repo: 'nail-calculator',    // æ‚¨çš„å°ˆæ¡ˆåç¨±
            path: 'data.json'           // æª”æ¡ˆè·¯å¾‘
        };

        let currentData = null;
        let fileSha = null; // æ›´æ–°æª”æ¡ˆæ™‚éœ€è¦é€™å€‹

        // æª¢æŸ¥æ˜¯å¦æœ‰å­˜é Token
        window.onload = function() {
            const savedToken = localStorage.getItem('gh_token');
            if(savedToken) {
                document.getElementById('token-input').value = savedToken;
            }
        }

        async function login() {
            const token = document.getElementById('token-input').value.trim();
            if(!token) return alert('è«‹è¼¸å…¥ Token');
            
            localStorage.setItem('gh_token', token); // è¨˜ä½ Token
            
            const btn = document.querySelector('button');
            btn.innerText = 'è®€å–è³‡æ–™ä¸­...';
            btn.disabled = true;

            try {
                // å¾ GitHub è®€å– data.json
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                    headers: { 'Authorization': `token ${token}` }
                });

                if(!response.ok) throw new Error('ç™»å…¥å¤±æ•—æˆ–æ‰¾ä¸åˆ°æª”æ¡ˆ');

                const data = await response.json();
                fileSha = data.sha; // é‡è¦ï¼šæ›´æ–°æ™‚éœ€è¦
                
                // GitHub å›å‚³çš„å…§å®¹æ˜¯ Base64 ç·¨ç¢¼ï¼Œéœ€è¦è§£ç¢¼ (æ”¯æ´ä¸­æ–‡)
                const content = decodeURIComponent(escape(window.atob(data.content)));
                currentData = JSON.parse(content);

                renderEditor();
                
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('editor-panel').style.display = 'block';

            } catch (e) {
                alert('éŒ¯èª¤ï¼š' + e.message);
                btn.innerText = 'ç™»å…¥å¾Œå°';
                btn.disabled = false;
            }
        }

        // æ¸²æŸ“ç·¨è¼¯å™¨ä»‹é¢
        function renderEditor() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';

            // 1. æœå‹™é¡åˆ¥ (Categories)
            currentData.categories.forEach((cat, catIndex) => {
                const section = document.createElement('div');
                section.className = 'section-card';
                
                let html = `<details open><summary class="section-title">ğŸ“‚ ${cat.title}</summary>`;
                
                cat.items.forEach((item, itemIndex) => {
                    html += `
                        <div class="item-row">
                            <label class="label">é …ç›®åç¨±</label>
                            <input type="text" class="price-input" style="text-align:left; margin-bottom:10px;" 
                                   value="${item.name}" onchange="updateValue('categories', ${catIndex}, 'items', ${itemIndex}, 'name', this.value)">
                            
                            <div class="flex-row">
                                <div class="col"><span class="label">åº—é•·</span>
                                    <input type="number" class="price-input" value="${getPrice(item.prices.manager)}" 
                                    onchange="updatePrice('categories', ${catIndex}, ${itemIndex}, 'manager', this.value)"></div>
                                <div class="col"><span class="label">ç¾ç”²å¸«</span>
                                    <input type="number" class="price-input" value="${getPrice(item.prices.artist)}" 
                                    onchange="updatePrice('categories', ${catIndex}, ${itemIndex}, 'artist', this.value)"></div>
                                <div class="col"><span class="label">åŠ©ç†</span>
                                    <input type="number" class="price-input" value="${getPrice(item.prices.assistant)}" 
                                    onchange="updatePrice('categories', ${catIndex}, ${itemIndex}, 'assistant', this.value)"></div>
                            </div>
                        </div>
                    `;
                });
                html += `</details>`;
                section.innerHTML = html;
                container.appendChild(section);
            });

            // 2. åŠ è³¼é …ç›® (Add-ons)
            const addonSection = document.createElement('div');
            addonSection.className = 'section-card';
            let addonHtml = `<details><summary class="section-title">â• åŠ è³¼èˆ‡å»¶ç”²</summary>`;
            
            currentData.add_ons.forEach((item, index) => {
                // åˆ¤æ–·åƒ¹æ ¼æ˜¯å–®ä¸€æ•¸å­—é‚„æ˜¯ç‰©ä»¶
                let isSimplePrice = typeof item.price === 'number';
                
                addonHtml += `
                    <div class="item-row">
                        <label class="label">${item.name}</label>
                        <div class="flex-row">
                `;

                if (isSimplePrice) {
                    addonHtml += `
                        <div class="col"><span class="label">çµ±ä¸€åƒ¹æ ¼</span>
                        <input type="number" class="price-input" value="${item.price}" 
                        onchange="updateAddonPrice(${index}, null, this.value)"></div>
                    `;
                } else {
                    addonHtml += `
                        <div class="col"><span class="label">åº—é•·/å¸«</span>
                        <input type="number" class="price-input" value="${item.prices.manager}" 
                        onchange="updateAddonPrice(${index}, 'manager', this.value)"></div>
                    `;
                }
                
                addonHtml += `</div></div>`;
            });
            addonHtml += `</details>`;
            addonSection.innerHTML = addonHtml;
            container.appendChild(addonSection);
        }

        // è¼”åŠ©ï¼šè™•ç†åƒ¹æ ¼å¯èƒ½æ˜¯é™£åˆ— [æ‰‹, è¶³] æˆ– å–®ä¸€æ•¸å­—
        function getPrice(val) {
            if(Array.isArray(val)) return val[0]; // ç°¡åŒ–ï¼šå¾Œå°æš«æ™‚åªé¡¯ç¤ºæ‰‹éƒ¨åƒ¹æ ¼ä¾›ç·¨è¼¯ (æˆ–çµ±ä¸€åƒ¹)
            return val === null ? '' : val;
        }

        // æ›´æ–°è³‡æ–™é‚è¼¯
        function updatePrice(type, catIdx, itemIdx, role, val) {
            let numVal = val === '' ? null : parseInt(val);
            let target = currentData.categories[catIdx].items[itemIdx].prices;
            
            // å¦‚æœåŸæœ¬æ˜¯é™£åˆ— [æ‰‹, è¶³]ï¼Œæˆ‘å€‘å‡è¨­è¶³éƒ¨è‡ªå‹• +100 æˆ– +200 çš„é‚è¼¯ (é€™è£¡ç°¡åŒ–ç‚ºåªæ”¹ä¸»åƒ¹æ ¼)
            // ç‚ºäº†å®Œæ•´æ€§ï¼Œå¦‚æœæ‚¨éœ€è¦æ‰‹è¶³åˆ†åˆ¥è¨­å®šï¼Œå¾Œå°UIæœƒæ›´è¤‡é›œã€‚
            // é€™è£¡æ¡ç”¨ç­–ç•¥ï¼šè‹¥åŸæœ¬æ˜¯é™£åˆ—ï¼Œå‰‡å…©å€‹éƒ½æ›´æ–°ç‚ºä¸€æ¨£ï¼Œæˆ–è€…ç¶­æŒåƒ¹å·® (ç›®å‰å…ˆè¨­ç‚ºä¸€æ¨£)
            if(Array.isArray(target[role])) {
                let diff = target[role][1] - target[role][0];
                target[role] = [numVal, numVal + diff]; 
            } else {
                target[role] = numVal;
            }
        }

        function updateValue(type, catIdx, subType, itemIdx, field, val) {
            currentData[type][catIdx][subType][itemIdx][field] = val;
        }

        function updateAddonPrice(index, role, val) {
            let numVal = parseInt(val);
            if(role) {
                currentData.add_ons[index].prices[role] = numVal;
                // åŒæ­¥æ›´æ–°ç¾ç”²å¸« (å‡è¨­ç›¸åŒ)
                if(currentData.add_ons[index].prices.artist !== undefined) 
                    currentData.add_ons[index].prices.artist = numVal;
            } else {
                currentData.add_ons[index].price = numVal;
            }
        }

        // å„²å­˜å› GitHub
        async function saveToGithub() {
            if(!confirm('ç¢ºå®šè¦å„²å­˜ä¿®æ”¹ä¸¦æ›´æ–°å‰å°å—ï¼Ÿ')) return;

            const token = localStorage.getItem('gh_token');
            const btn = document.getElementById('save-btn');
            btn.innerText = 'ä¸Šå‚³ä¸­...';
            btn.disabled = true;

            // è½‰å› JSON ä¸¦ç·¨ç¢¼
            const jsonString = JSON.stringify(currentData, null, 4);
            const contentEncoded = window.btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: "Update prices via Admin Panel",
                content: contentEncoded,
                sha: fileSha // å¿…é ˆå¸¶ä¸Šé€™å€‹æ‰èƒ½è¦†è“‹
            };

            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if(!response.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                
                // æ›´æ–°æ–°çš„ SHA
                const resData = await response.json();
                fileSha = resData.content.sha;

                alert('âœ… å„²å­˜æˆåŠŸï¼å‰å°åƒ¹æ ¼å·²æ›´æ–° (è«‹ç¨ç­‰1åˆ†é˜è®“ GitHub æ›´æ–°)');
                btn.innerText = 'ğŸ’¾ å„²å­˜ä¿®æ”¹';
                btn.disabled = false;

            } catch (e) {
                alert('å„²å­˜å¤±æ•—ï¼š' + e.message);
                btn.innerText = 'ğŸ’¾ å„²å­˜ä¿®æ”¹';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
