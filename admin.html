<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Fairy. L å¾Œå°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<style>
/* æ¥µé€Ÿç‰ˆ CSS */
:root{--bg:#F6F1ED;--c:#FFF;--t:#4E342E;--a:#8D6E63;--r:#d32f2f;--g:#f5f5f5}
*{box-sizing:border-box;outline:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--t);font-family:'Noto Sans TC',sans-serif;padding:15px;margin:0;padding-bottom:100px}
h1{text-align:center;margin:10px 0 5px;font-size:1.5rem}.sub{text-align:center;font-size:.9rem;color:var(--a);margin-bottom:20px}
.card{max-width:400px;margin:20px auto;background:var(--c);padding:25px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.05);text-align:center}
input,select{width:100%;padding:12px;margin-top:10px;border:1px solid #ddd;border-radius:12px;font-size:1rem;background:var(--g)}
.btn{background:var(--t);color:#fff;border:0;padding:12px 0;border-radius:50px;font-size:1rem;margin-top:20px;cursor:pointer;width:100%;font-weight:700}
.btn:active,.icon:active{transform:scale(.98);opacity:.9}.link{background:0 0;border:0;color:var(--a);cursor:pointer;margin-top:15px;text-decoration:underline;font-size:.9rem}
#gen{display:none;border:2px dashed var(--a)}.res{margin-top:15px;padding:10px;background:#eee;word-break:break-all;font-family:monospace;font-size:.8rem;border-radius:8px;user-select:all}
#edit{display:none;width:100%;max-width:600px;margin:0 auto}
.sec{background:var(--c);border-radius:16px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
.head{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--bg);padding-bottom:10px;margin-bottom:10px;flex-wrap:wrap;gap:10px}
.inp-t{font-size:1.1rem;font-weight:700;border:0;background:0 0;color:var(--t);flex:1;min-width:150px}
.row{background:#fff;padding:10px 0;border-bottom:1px dashed #e0e0e0}.row:last-child{border-bottom:0}
.top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
.inp-n{flex:1;padding:8px;border:1px solid #e0e0e0;border-radius:8px;font-weight:700}
.grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:var(--bg);padding:10px;border-radius:10px}
.col{display:flex;flex-direction:column;align-items:center}.lbl{font-size:.75rem;color:#888;margin-bottom:4px}
.inp-p{width:100%;padding:8px 0;border:1px solid #ddd;border-radius:8px;text-align:center;font-weight:700}
.g-btn{display:flex;gap:5px}.icon{width:32px;height:32px;border-radius:8px;border:0;background:var(--g);display:flex;justify-content:center;align-items:center;cursor:pointer}
.del{color:var(--r);background:#ffebee}.add{width:100%;padding:12px;background:#fcfcfc;border:2px dashed #ddd;border-radius:10px;color:#888;margin-top:5px;cursor:pointer}
.add-c{width:100%;padding:15px;background:0 0;border:2px dashed var(--a);border-radius:16px;color:var(--a);font-weight:700;margin-bottom:30px;cursor:pointer}
#bar{position:fixed;bottom:20px;left:50%;transform:translate(-50%,150%);background:var(--t);color:#fff;padding:10px 20px;border-radius:50px;box-shadow:0 5px 20px rgba(0,0,0,.3);z-index:99;display:flex;align-items:center;gap:15px;transition:.3s;width:90%;max-width:400px;justify-content:space-between}
#bar.show{transform:translate(-50%,0)}.b-s{background:#fff;color:var(--t);border:0;padding:10px 20px;border-radius:30px;font-weight:700;cursor:pointer}
.b-c{background:rgba(255,255,255,.2);color:#fff;border:0;padding:10px 15px;border-radius:30px;cursor:pointer}
.secret{position:absolute;bottom:10px;left:50%;transform:translate(-50%);background:0 0;border:0;color:var(--bg);padding:20px;cursor:default}
</style>
</head>
<body>
    <h1>Fairy. L å¾Œå°</h1>
    <div class="sub">CMS System</div>

    <div id="login" class="card">
        <h3>ç®¡ç†è€…ç™»å…¥</h3>
        <select id="sel"><option value="" disabled>è¼‰å…¥ä¸­...</option></select>
        <input type="password" id="pwd" placeholder="è¼¸å…¥çŸ­å¯†ç¢¼ (å¦‚ 8888)">
        <button class="btn" onclick="log()">ç™»å…¥</button>
    </div>

    <div id="gen" class="card">
        <h3>ğŸ” ç”¢ç”Ÿä»£ç¢¼</h3>
        <input type="text" id="gt" placeholder="GitHub Token"><input type="text" id="gp" placeholder="çŸ­å¯†ç¢¼">
        <button class="btn" onclick="make()">ç”¢ç”Ÿ</button><div id="gr" class="res" style="display:none"></div>
        <button class="link" onclick="tog()">è¿”å›</button>
    </div>

    <div id="edit">
        <div id="area"></div>
        <button class="add-c" onclick="addC()">ï¼‹ æ–°åˆ†é¡</button>
        <div class="sub">â€”â€”â€”â€” å…¶ä»–è¨­å®š â€”â€”â€”â€”</div>
        <div id="add-area"></div>
    </div>

    <div id="bar">
        <div style="font-size:.9rem;font-weight:700">å·²ä¿®æ”¹å…§å®¹</div>
        <div style="display:flex;gap:10px"><button class="b-c" onclick="cancel()">å–æ¶ˆ</button><button class="b-s" id="sb" onclick="save()">ğŸ’¾ å„²å­˜</button></div>
    </div>

    <button class="secret" onclick="tog()">åˆæ¬¡è¨­å®š</button>

    <script>
        const CFG={owner:'machael090807',repo:'nail-calculator',path:'data.json'};
        let UL=[],CD=null,OD=null,SHA=null,TK=null;

        window.onload=async()=>{
            try{
                let r=await fetch('admin_user.json?v='+Date.now());
                if(r.ok){
                    UL=await r.json(); let s=document.getElementById('sel'); s.innerHTML='';
                    UL.forEach((u,i)=>{let o=document.createElement('option');o.value=i;o.innerText=u.name;s.appendChild(o)});
                    if(UL.length) s.value=0;
                }
            }catch(e){}
        };

        const X=(t,p)=>btoa(t.split('').map((c,i)=>String.fromCharCode(c.charCodeAt(0)^p.charCodeAt(i%p.length))).join(''));
        const Y=(e,p)=>{try{return atob(e).split('').map((c,i)=>String.fromCharCode(c.charCodeAt(0)^p.charCodeAt(i%p.length))).join('')}catch{return''}};
        
        function tog(){let l=document.getElementById('login'),g=document.getElementById('gen');g.style.display=g.style.display==='block'?(l.style.display='block','none'):(l.style.display='none','block')}
        function make(){let t=document.getElementById('gt').value,p=document.getElementById('gp').value,r=document.getElementById('gr');if(!t||!p)return;r.style.display='block';r.innerText=X(t,p)}
        
        async function log(){
            let s=document.getElementById('sel'),p=document.getElementById('pwd').value,b=document.querySelector('#login .btn');
            if(s.value===""||!p)return alert("è«‹è¼¸å…¥å¯†ç¢¼");
            let k=Y(UL[s.value].cipher,p);
            if(!k.startsWith('ghp_'))return alert("å¯†ç¢¼éŒ¯èª¤");
            b.innerText='...';b.disabled=true;
            try{
                let r=await fetch(`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.path}`,{headers:{'Authorization':`token ${k}`}});
                if(!r.ok)throw new Error();
                let d=await r.json(); SHA=d.sha; 
                CD=JSON.parse(decodeURIComponent(escape(atob(d.content))));
                if(!CD.categories)CD.categories=[];if(!CD.add_ons)CD.add_ons=[];
                OD=JSON.parse(JSON.stringify(CD)); TK=k; render();
                document.getElementById('login').style.display='none';document.getElementById('edit').style.display='block';
            }catch{alert('ç™»å…¥å¤±æ•—');b.innerText='ç™»å…¥';b.disabled=false}
        }

        function chk(){let b=document.getElementById('bar');JSON.stringify(CD)!==JSON.stringify(OD)?b.classList.add('show'):b.classList.remove('show')}
        function cancel(){if(confirm("é‚„åŸï¼Ÿ")){CD=JSON.parse(JSON.stringify(OD));render();chk()}}
        function render(){rndC();rndA()}
        
        function rndC(){
            let h='',c=document.getElementById('area');
            CD.categories.forEach((x,i)=>{
                h+=`<div class="sec"><div class="head"><input class="inp-t" value="${x.title}" onchange="upT(${i},this.value)"><div class="g-btn"><button class="icon" onclick="mvC(${i},-1)">â¬†ï¸</button><button class="icon" onclick="mvC(${i},1)">â¬‡ï¸</button><button class="icon del" onclick="delC(${i})">ğŸ—‘ï¸</button></div></div>`;
                x.items.forEach((y,j)=>{
                    h+=`<div class="row"><div class="top"><input class="inp-n" value="${y.name}" onchange="upN(${i},${j},this.value)"><div class="g-btn"><button class="icon" onclick="mvI(${i},${j},-1)">â¬†ï¸</button><button class="icon" onclick="mvI(${i},${j},1)">â¬‡ï¸</button><button class="icon del" onclick="delI(${i},${j})">âœ–ï¸</button></div></div><div class="grid"><div class="col"><span class="lbl">åº—é•·</span><input type="number" class="inp-p" value="${getP(y.prices.manager)}" onchange="upP(${i},${j},'manager',this.value)"></div><div class="col"><span class="lbl">ç¾ç”²å¸«</span><input type="number" class="inp-p" value="${getP(y.prices.artist)}" onchange="upP(${i},${j},'artist',this.value)"></div><div class="col"><span class="lbl">åŠ©ç†</span><input type="number" class="inp-p" value="${getP(y.prices.assistant)}" onchange="upP(${i},${j},'assistant',this.value)"></div></div></div>`
                });
                h+=`<button class="add" onclick="adI(${i})">ï¼‹ é …ç›®</button></div>`
            }); c.innerHTML=h;
        }

        function rndA(){
            let h='<div class="sec"><div class="head"><b>åŠ è³¼è¨­å®š</b></div>',c=document.getElementById('add-area');
            CD.add_ons.forEach((x,i)=>{
                let v=typeof x.price==='number'?x.price:x.prices.manager;
                h+=`<div class="row" style="display:flex;align-items:center"><input class="inp-n" value="${x.name}" disabled style="background:#eee;color:#888"><input type="number" class="inp-p" style="width:80px;margin-left:10px" value="${v}" onchange="upA(${i},this.value)"></div>`
            }); c.innerHTML=h+'</div>';
        }

        const getP=p=>Array.isArray(p)?p[0]:p;
        const upT=(i,v)=>{CD.categories[i].title=v;chk()};
        const upN=(i,j,v)=>{CD.categories[i].items[j].name=v;chk()};
        const upP=(i,j,r,v)=>{let n=v===''?null:parseInt(v),p=CD.categories[i].items[j].prices;Array.isArray(p[r])?p[r]=[n,n+(p[r][1]-p[r][0])]:p[r]=n;chk()};
        const upA=(i,v)=>{let n=parseInt(v),o=CD.add_ons[i];typeof o.price==='number'?o.price=n:(o.prices.manager=n,o.prices.artist&&(o.prices.artist=n),o.prices.assistant&&(o.prices.assistant=n));chk()};
        const addC=()=>{CD.categories.push({title:"æ–°åˆ†é¡",items:[]});render();chk()};
        const delC=i=>{if(confirm("åˆªé™¤ï¼Ÿ"))CD.categories.splice(i,1);render();chk()};
        const mvC=(i,d)=>{if(i+d<0||i+d>=CD.categories.length)return;[CD.categories[i],CD.categories[i+d]]=[CD.categories[i+d],CD.categories[i]];render();chk()};
        const adI=i=>{CD.categories[i].items.push({id:'i'+Date.now(),name:"æ–°é …ç›®",prices:{manager:0,artist:0,assistant:0}});render();chk()};
        const delI=(i,j)=>{if(confirm("åˆªé™¤ï¼Ÿ"))CD.categories[i].items.splice(j,1);render();chk()};
        const mvI=(i,j,d)=>{let t=CD.categories[i].items;if(j+d<0||j+d>=t.length)return;[t[j],t[j+d]]=[t[j+d],t[j]];render();chk()};

        async function save(){
            if(!confirm("å„²å­˜ï¼Ÿ"))return;
            let b=document.getElementById('sb'),ot=b.innerText; b.innerText='...'; b.disabled=true;
            try{
                let r=await fetch(`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.path}`,{
                    method:'PUT',headers:{'Authorization':`token ${TK}`,'Content-Type':'application/json'},
                    body:JSON.stringify({message:"Upd",content:btoa(unescape(encodeURIComponent(JSON.stringify(CD,null,4)))),sha:SHA})
                });
                if(!r.ok)throw new Error(); let d=await r.json(); SHA=d.content.sha;
                OD=JSON.parse(JSON.stringify(CD));chk();alert('OK');
            }catch{alert('Fail')}
            b.innerText=ot;b.disabled=false;
        }
    </script>
</body>
</html>
