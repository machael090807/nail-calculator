<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L å¾Œå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. æ ¸å¿ƒè®Šæ•¸èˆ‡é‡ç½® --- */
        :root { 
            --bg: #F8F6F4; --card: #FFFFFF; 
            --text-main: #4E342E; --text-sub: #8D6E63;
            --primary: #5D4037; --danger: #EF5350;
            --input-bg: #F2F2F7; --radius: 16px;
            --shadow: 0 4px 20px rgba(109, 76, 65, 0.05);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; padding-bottom: 100px; }

        /* --- 2. é ‚éƒ¨å°èˆª (App Header) --- */
        .app-header {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px 20px; position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin: 0; }
        .btn-logout { background: #F5F5F5; border: none; padding: 6px 12px; border-radius: 20px; color: var(--text-sub); font-size: 0.85rem; font-weight: bold; cursor: pointer; }

        /* --- 3. iOS åˆ†é é¸å–® --- */
        .tabs-wrapper { padding: 10px 20px; background: var(--bg); position: sticky; top: 60px; z-index: 40; }
        .tabs { display: flex; background: #E0E0E0; padding: 4px; border-radius: 12px; }
        .tab { flex: 1; text-align: center; padding: 8px 0; border-radius: 9px; font-size: 0.9rem; font-weight: bold; color: #9E9E9E; cursor: pointer; transition: 0.2s; }
        .tab.active { background: var(--card); color: var(--text-main); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

        /* --- 4. å…§å®¹å¡ç‰‡ --- */
        .page { display: none; padding: 10px 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; padding-top: 45px; }
        .section-header { font-size: 1.1rem; font-weight: 800; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); }

        /* --- 5. æ“ä½œæŒ‰éˆ•å€ (å³ä¸Šè§’) --- */
        .card-actions {
            position: absolute; top: 10px; right: 10px;
            display: flex; gap: 8px;
        }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer; transition: 0.2s;
            background: #F5F5F5; color: #757575; font-weight: bold;
        }
        .btn-icon:active { background: #E0E0E0; }
        .btn-del { background: #FFEBEE; color: var(--danger); }

        /* --- 6. è¼¸å…¥å…ƒä»¶ --- */
        label { display: block; margin-top: 5px; font-size: 0.85rem; color: var(--text-sub); font-weight: bold; margin-bottom: 6px; }
        input { width: 100%; padding: 12px; border: none; background: var(--input-bg); border-radius: 10px; font-size: 1rem; color: var(--text-main); outline: none; font-weight: 500; transition: 0.2s; }
        input:focus { background: #EAEAEA; }

        /* åƒ¹æ ¼ç¾¤çµ„ */
        .price-group { background: #FAFAFA; padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px dashed #E0E0E0; }
        .price-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .price-row:last-child { margin-bottom: 0; }
        .price-label { width: 50px; font-size: 0.85rem; color: #9E9E9E; font-weight: bold; }

        /* --- 7. æŒ‰éˆ• --- */
        .btn-act { border: none; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.95); }
        .btn-add { background: var(--primary); color: white; width: 100%; margin-top: 15px; padding: 12px; border-radius: 12px; font-size: 1rem; }
        
        /* --- 8. åº•éƒ¨æµ®å‹•æ“ä½œåˆ— (App Toolbar) --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; 
            padding: 15px 20px calc(15px + var(--safe-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
            z-index: 90;
            display: flex; gap: 12px;
            transform: translateY(100%); /* é è¨­éš±è— */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .bottom-bar.show { transform: translateY(0); } /* é¡¯ç¤ºæ™‚æ»‘ä¸Šä¾† */

        .btn-cancel { flex: 1; background: #F5F5F5; color: #757575; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-save { flex: 2; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(93, 64, 55, 0.3); }

        /* --- 9. ç™»å…¥ & ç”¢ç”Ÿå™¨ --- */
        #login_view { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; background: var(--bg); transition: 0.3s; }
        .login-card { background: white; width: 85%; max-width: 350px; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; }
        .login-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 25px; }
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 14px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; margin-top: 20px; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.2); cursor: pointer; }
        select.form-control { width: 100%; padding: 12px; border: none; background: var(--input-bg); border-radius: 10px; font-size: 1rem; outline: none; -webkit-appearance: none; color: var(--text-main); margin-bottom: 15px; }
        
        .btn-ninja { margin-top: 50px; background: transparent; color: var(--bg); border: none; font-size: 1rem; width: 100px; height: 50px; cursor: default; }
        .btn-ninja:hover { cursor: pointer; }

        #gen_modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 200; justify-content: center; align-items: center; }
        .gen-box { background: white; padding: 30px; border-radius: 20px; width: 320px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="login_view">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size:1.8rem; color:var(--text-main);">Fairy. L</h1>
            <span style="color:var(--text-sub);">å¾Œå°ç®¡ç†ç³»çµ±</span>
        </div>
        <div class="login-card">
            <div class="login-title">ç®¡ç†è€…ç™»å…¥</div>
            <select id="user_select" class="form-control">
                <option value="" disabled selected>è®€å–ä½¿ç”¨è€…ä¸­...</option>
            </select>
            <input type="password" id="password_input" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align:center; letter-spacing:3px;">
            <button class="btn-login" onclick="attemptLogin()">ç™»å…¥</button>
            <div id="login_msg" style="color:#EF5350; font-size:0.85rem; margin-top:15px; height:20px;"></div>
        </div>
        <button class="btn-ninja" onclick="document.getElementById('gen_modal').style.display='flex'">â€¢</button>
    </div>

    <div id="gen_modal">
        <div class="gen-box">
            <div onclick="document.getElementById('gen_modal').style.display='none'" style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:1.2rem; padding:5px;">âœ•</div>
            <h3 style="margin-top:0; text-align:center; color:var(--text-main);">ğŸ” ç”¢ç”Ÿé‡‘é‘°</h3>
            <p style="text-align:center; font-size:0.85rem; color:#999; margin-bottom:20px;">åªéœ€ Tokenï¼Œå¸³è™Ÿèˆ‡ Repo å·²å…§å»º</p>
            <label>GitHub Token</label>
            <input type="text" id="g_token" placeholder="ghp_xxxxxxxx...">
            <label>è¨­å®šå¯†ç¢¼</label>
            <input type="text" id="g_pass" placeholder="è¨­å®šä½ çš„ç™»å…¥å¯†ç¢¼">
            <button class="btn-login" style="margin-top:25px" onclick="generateCipher()">ç”¢ç”Ÿä¸¦è¤‡è£½</button>
            <div id="g_result" style="display:none; margin-top:15px; padding:10px; background:#F5F5F5; word-break:break-all; font-family:monospace; border-radius:8px; font-size:0.8rem; color:#333;"></div>
            <div id="g_msg" style="display:none; color:green; text-align:center; font-size:0.8rem; margin-top:5px;">âœ… å·²è¤‡è£½ï¼è«‹è²¼åˆ° JSON</div>
        </div>
    </div>

    <div id="admin_view" style="display:none;">
        <div class="app-header">
            <div class="app-title">å¾Œå°ç®¡ç†</div>
            <button class="btn-logout" onclick="location.reload()">ç™»å‡º</button>
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('tab_settings')">å…¨åŸŸè¨­å®š</div>
                <div class="tab" onclick="switchTab('tab_categories')">æœå‹™èœå–®</div>
                <div class="tab" onclick="switchTab('tab_others')">å…¶ä»–é …ç›®</div>
            </div>
        </div>

        <div id="tab_settings" class="page active">
            <div class="card" style="padding-top:20px;">
                <div class="section-header">ğŸ‚ å„ªæƒ èˆ‡å…¶ä»–</div>
                <label>ç•¶æœˆå£½æ˜ŸæŠ˜æ‰£ (0.9 = 9æŠ˜)</label>
                <input type="number" id="set_birthday" step="0.01" oninput="checkChanges()">
            </div>
            <div class="card" style="padding-top:20px;">
                <div class="section-header">ğŸ“ ä½ç½®åŠ åƒ¹</div>
                <label>æ‰‹éƒ¨é¡¯ç¤ºåç¨±</label>
                <input type="text" id="set_hand_name" oninput="checkChanges()">
                <label>è¶³éƒ¨é¡¯ç¤ºåç¨±</label>
                <input type="text" id="set_foot_name" oninput="checkChanges()">
                <label>è¶³éƒ¨åŠ åƒ¹é‡‘é¡ ($)</label>
                <input type="number" id="set_foot_price" oninput="checkChanges()">
            </div>
        </div>

        <div id="tab_categories" class="page">
            <div id="categories_container"></div>
            <button class="btn-add" onclick="addCategory()">+ æ–°å¢æœå‹™å¤§åˆ†é¡</button>
        </div>

        <div id="tab_others" class="page">
            <div class="section-header"><span>ğŸ’… å¸ç”²é …ç›®</span><button class="btn-act" style="background:#D7CCC8; color:var(--text-main);" onclick="addRemoval()">æ–°å¢</button></div>
            <div id="removals_container"></div>
            <div class="section-header" style="margin-top:30px"><span>â• åŠ è³¼é …ç›®</span><button class="btn-act" style="background:#D7CCC8; color:var(--text-main);" onclick="addAddon()">æ–°å¢</button></div>
            <div id="addons_container"></div>
        </div>

        <div class="bottom-bar" id="action_bar">
            <button class="btn-cancel" onclick="cancelChanges()">å–æ¶ˆå¾©åŸ</button>
            <button class="btn-save" onclick="saveData()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè¨­å®š ---
        const GITHUB_CONFIG = { user: "machael090807", repo: "nail-calculator", path: "data.json" };

        let DATA = { settings: {}, categories: [], removals: [], add_ons: [], sha: "" };
        let ORIGINAL_DATA_STR = "";
        let USER_LIST = [];
        let CURRENT_TOKEN = "";

        window.onload = async function() {
            try {
                const res = await fetch('admin_user.json?v=' + Date.now());
                if(res.ok) { USER_LIST = await res.json(); renderUserSelect(); }
            } catch(e) {}
        };

        function renderUserSelect() {
            const select = document.getElementById('user_select');
            select.innerHTML = '';
            USER_LIST.forEach((u, idx) => {
                const opt = document.createElement('option');
                opt.value = idx; opt.innerText = u.name;
                select.appendChild(opt);
            });
        }

        function attemptLogin() {
            const idx = document.getElementById('user_select').value;
            const pwd = document.getElementById('password_input').value;
            const msg = document.getElementById('login_msg');
            if(!pwd || idx === "") return msg.innerText = "è«‹è¼¸å…¥å¯†ç¢¼";
            const target = USER_LIST[idx];
            msg.innerText = "é©—è­‰ä¸­...";
            const token = xor_process(atob(target.cipher), pwd);
            if(token.startsWith('ghp_') || token.length > 20) {
                CURRENT_TOKEN = token;
                loadDataFromGitHub().then(() => {
                    document.getElementById('login_view').style.opacity = '0';
                    setTimeout(() => { document.getElementById('login_view').style.display = 'none'; document.getElementById('admin_view').style.display = 'block'; }, 300);
                }).catch(() => msg.innerText = "âŒ å¯†ç¢¼æ­£ç¢ºä½†ç„¡æ³•é€£ç·š");
            } else { msg.innerText = "âŒ å¯†ç¢¼éŒ¯èª¤"; }
        }

        async function loadDataFromGitHub() {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${CURRENT_TOKEN}` } });
            if (!res.ok) throw new Error("API Error");
            const json = await res.json();
            const content = decodeURIComponent(escape(atob(json.content)));
            DATA = JSON.parse(content);
            DATA.sha = json.sha;
            if (!DATA.settings) DATA.settings = {};
            ORIGINAL_DATA_STR = JSON.stringify(DATA);
            renderAll();
        }

        function checkChanges() {
            DATA.settings.birthday_discount = parseFloat(document.getElementById('set_birthday').value);
            DATA.settings.location_hand_name = document.getElementById('set_hand_name').value;
            DATA.settings.location_foot_name = document.getElementById('set_foot_name').value;
            DATA.settings.location_foot_surcharge = parseInt(document.getElementById('set_foot_price').value);
            const currentStr = JSON.stringify(DATA);
            const bar = document.getElementById('action_bar');
            if (currentStr !== ORIGINAL_DATA_STR) bar.classList.add('show'); else bar.classList.remove('show');
        }

        function cancelChanges() {
            if(confirm("ç¢ºå®šè¦æ”¾æ£„æ‰€æœ‰ä¿®æ”¹ï¼Œæ¢å¾©æˆåŸæœ¬çš„æ¨£å­å—ï¼Ÿ")) {
                DATA = JSON.parse(ORIGINAL_DATA_STR);
                renderAll();
                document.getElementById('action_bar').classList.remove('show');
            }
        }

        function renderAll() {
            document.getElementById('set_birthday').value = DATA.settings.birthday_discount || 0.9;
            document.getElementById('set_hand_name').value = DATA.settings.location_hand_name || "ğŸ–ï¸ æ‰‹éƒ¨";
            document.getElementById('set_foot_name').value = DATA.settings.location_foot_name || "ğŸ¦¶ è¶³éƒ¨";
            document.getElementById('set_foot_price').value = DATA.settings.location_foot_surcharge || 200;
            renderCategories();
            renderRemovals();
            renderAddons();
        }

        // --- æ’åºåŠŸèƒ½ (é€šç”¨) ---
        function moveCategory(idx, dir) {
            const newIdx = idx + dir;
            if(newIdx < 0 || newIdx >= DATA.categories.length) return;
            [DATA.categories[idx], DATA.categories[newIdx]] = [DATA.categories[newIdx], DATA.categories[idx]];
            renderCategories(); checkChanges();
        }

        function moveItem(cIdx, iIdx, dir) {
            const items = DATA.categories[cIdx].items;
            const newIdx = iIdx + dir;
            if(newIdx < 0 || newIdx >= items.length) return;
            [items[iIdx], items[newIdx]] = [items[newIdx], items[iIdx]];
            renderCategories(); checkChanges();
        }

        function moveRemoval(idx, dir) {
            const newIdx = idx + dir;
            if(newIdx < 0 || newIdx >= DATA.removals.length) return;
            [DATA.removals[idx], DATA.removals[newIdx]] = [DATA.removals[newIdx], DATA.removals[idx]];
            renderRemovals(); checkChanges();
        }

        function moveAddon(idx, dir) {
            const newIdx = idx + dir;
            if(newIdx < 0 || newIdx >= DATA.add_ons.length) return;
            [DATA.add_ons[idx], DATA.add_ons[newIdx]] = [DATA.add_ons[newIdx], DATA.add_ons[idx]];
            renderAddons(); checkChanges();
        }

        // --- ç”¢ç”ŸæŒ‰éˆ•ç¾¤çµ„ HTML ---
        function getActionsHTML(type, idx, subIdx, total) {
            const isFirst = (type === 'cat' || type === 'rm' || type === 'addon') ? idx === 0 : subIdx === 0;
            const isLast = (type === 'cat' || type === 'rm' || type === 'addon') ? idx === total - 1 : subIdx === total - 1;
            
            let upFunc, downFunc, delFunc;
            if (type === 'cat') { upFunc=`moveCategory(${idx}, -1)`; downFunc=`moveCategory(${idx}, 1)`; delFunc=`delCategory(${idx})`; }
            else if (type === 'item') { upFunc=`moveItem(${idx}, ${subIdx}, -1)`; downFunc=`moveItem(${idx}, ${subIdx}, 1)`; delFunc=`delItem(${idx}, ${subIdx})`; }
            else if (type === 'rm') { upFunc=`moveRemoval(${idx}, -1)`; downFunc=`moveRemoval(${idx}, 1)`; delFunc=`delRemoval(${idx})`; }
            else if (type === 'addon') { upFunc=`moveAddon(${idx}, -1)`; downFunc=`moveAddon(${idx}, 1)`; delFunc=`delAddon(${idx})`; }

            const upStyle = isFirst ? 'visibility:hidden' : '';
            const downStyle = isLast ? 'visibility:hidden' : '';

            return `
                <div class="card-actions">
                    <button class="btn-icon" style="${upStyle}" onclick="${upFunc}">â†‘</button>
                    <button class="btn-icon" style="${downStyle}" onclick="${downFunc}">â†“</button>
                    <button class="btn-icon btn-del" onclick="${delFunc}">âœ•</button>
                </div>
            `;
        }

        function renderCategories() {
            const container = document.getElementById('categories_container');
            container.innerHTML = '';
            (DATA.categories || []).forEach((cat, cIdx) => {
                let itemsHtml = '';
                cat.items.forEach((item, iIdx) => { 
                    itemsHtml += `
                        <div style="background:#FAFAFA; padding:15px; border-radius:12px; margin-bottom:12px; position:relative; border:1px solid #EEE; padding-top:45px;">
                            ${getActionsHTML('item', cIdx, iIdx, cat.items.length)}
                            <label style="margin-top:0">åç¨±</label><input type="text" value="${item.name}" oninput="DATA.categories[${cIdx}].items[${iIdx}].name=this.value; checkChanges()" style="background:white">
                            ${getPriceInputsHTML('item', cIdx, iIdx, item.prices)}
                        </div>`;
                });
                
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    ${getActionsHTML('cat', cIdx, null, DATA.categories.length)}
                    <label>åˆ†é¡æ¨™é¡Œ</label>
                    <input type="text" value="${cat.title}" oninput="DATA.categories[${cIdx}].title=this.value; checkChanges()">
                    <div style="margin-top:15px; padding-left:10px; border-left: 3px solid #EFEBE9;">${itemsHtml}<button class="btn-act" style="background:#EEE; width:100%; margin-top:10px" onclick="addItem(${cIdx})">+ æ–°å¢é …ç›®</button></div>`;
                container.appendChild(div);
            });
        }

        function renderRemovals() {
            const container = document.getElementById('removals_container');
            container.innerHTML = '';
            (DATA.removals || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    ${getActionsHTML('rm', idx, null, DATA.removals.length)}
                    <label style="margin-top:0">åç¨±</label><input type="text" value="${item.name}" oninput="DATA.removals[${idx}].name=this.value; checkChanges()" style="background:white">
                    ${getPriceInputsHTML('rm', null, idx, item.prices)}`;
                container.appendChild(div);
            });
        }

        function renderAddons() {
            const container = document.getElementById('addons_container');
            container.innerHTML = '';
            (DATA.add_ons || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                let priceHtml = item.prices && typeof item.prices === 'object' 
                    ? getPriceInputsHTML('addon', null, idx, item.prices)
                    : `<label>å–®åƒ¹</label><input type="number" value="${item.price||0}" oninput="updateAddonSimplePrice(${idx}, this.value)">`;
                div.innerHTML = `
                    ${getActionsHTML('addon', idx, null, DATA.add_ons.length)}
                    <label>é …ç›®åç¨±</label><input type="text" value="${item.name}" oninput="DATA.add_ons[${idx}].name=this.value; checkChanges()">
                    <div style="display:flex; gap:10px"><div style="flex:1"><label>å–®ä½</label><input type="text" value="${item.unit_desc||''}" oninput="DATA.add_ons[${idx}].unit_desc=this.value; checkChanges()"></div></div>${priceHtml}`;
                container.appendChild(div);
            });
        }

        function getPriceInputsHTML(type, cIdx, iIdx, prices) {
            let p = prices;
            if (typeof p !== 'object' || p === null) { let val = (typeof p === 'number') ? p : ''; p = { manager: val, artist: val, assistant: val }; }
            const update = (role) => {
                if (type === 'item') return `updatePrice('item', ${cIdx}, ${iIdx}, '${role}', this.value)`;
                if (type === 'rm') return `updatePrice('rm', null, ${iIdx}, '${role}', this.value)`;
                if (type === 'addon') return `updatePrice('addon', null, ${iIdx}, '${role}', this.value)`;
            };
            const val = (v) => Array.isArray(v) ? v[0] : (v === null ? '' : v);
            return `<div class="price-group">
                    <div class="price-row"><span class="price-label">åº—é•·</span><input type="number" placeholder="ç„¡" value="${val(p.manager)}" oninput="${update('manager')}"></div>
                    <div class="price-row"><span class="price-label">ç¾ç”²å¸«</span><input type="number" placeholder="ç„¡" value="${val(p.artist)}" oninput="${update('artist')}"></div>
                    <div class="price-row"><span class="price-label">åŠ©ç†</span><input type="number" placeholder="ç„¡" value="${val(p.assistant)}" oninput="${update('assistant')}"></div></div>`;
        }

        function updatePrice(type, cIdx, iIdx, role, val) {
            let target;
            if (type === 'item') target = DATA.categories[cIdx].items[iIdx];
            else if (type === 'rm') target = DATA.removals[iIdx];
            else if (type === 'addon') target = DATA.add_ons[iIdx];
            if (!target.prices || typeof target.prices !== 'object') target.prices = { manager:null, artist:null, assistant:null };
            target.prices[role] = val === '' ? null : parseInt(val);
            checkChanges();
        }
        function updateAddonSimplePrice(idx, val) { DATA.add_ons[idx].price = parseInt(val) || 0; delete DATA.add_ons[idx].prices; checkChanges(); }

        function addCategory() { DATA.categories.push({ title: "æ–°åˆ†é¡", items: [] }); renderCategories(); checkChanges(); }
        function delCategory(idx) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ")) { DATA.categories.splice(idx, 1); renderCategories(); checkChanges(); } }
        function addItem(cIdx) { DATA.categories[cIdx].items.push({ id: 'i'+Date.now(), name: "æ–°é …ç›®", prices: { manager:0, artist:0, assistant:0 } }); renderCategories(); checkChanges(); }
        function delItem(cIdx, iIdx) { DATA.categories[cIdx].items.splice(iIdx, 1); renderCategories(); checkChanges(); }
        function addRemoval() { DATA.removals.push({ id: 'r'+Date.now(), name: "æ–°å¸ç”²", prices: { manager:0, artist:0, assistant:0 } }); renderRemovals(); checkChanges(); }
        function delRemoval(idx) { DATA.removals.splice(idx, 1); renderRemovals(); checkChanges(); }
        function addAddon() { DATA.add_ons.push({ id: 'a'+Date.now(), name: "æ–°åŠ è³¼", price: 100 }); renderAddons(); checkChanges(); }
        function delAddon(idx) { DATA.add_ons.splice(idx, 1); renderAddons(); checkChanges(); }

        async function saveData() {
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));
            const body = { message: "Update via Admin", content: content, sha: DATA.sha };
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CURRENT_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) { 
                    const json = await res.json(); DATA.sha = json.content.sha; 
                    ORIGINAL_DATA_STR = JSON.stringify(DATA); document.getElementById('action_bar').classList.remove('show');
                    alert("âœ… å„²å­˜æˆåŠŸï¼"); 
                } else throw new Error();
            } catch (e) { alert("âŒ å„²å­˜å¤±æ•—"); } finally { btn.innerText = originalText; }
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }
        function generateCipher() {
            const t = document.getElementById('g_token').value.trim();
            const p = document.getElementById('g_pass').value.trim();
            if(!t || !p) return alert("è«‹å¡«å¯«è³‡æ–™");
            const c = btoa(xor_process(t, p));
            document.getElementById('g_result').innerText = c;
            document.getElementById('g_result').style.display='block';
            navigator.clipboard.writeText(c).then(() => document.getElementById('g_msg').style.display='block');
        }
        function xor_process(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) { result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
            return result;
        }
    </script>
</body>
</html>
