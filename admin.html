<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L å¾Œå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --accent: #8D6E63; --danger: #d32f2f; --success: #388E3C; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px; padding-bottom: 80px; }
        h1 { text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--accent); margin-bottom: 30px; }
        
        /* ç™»å…¥å€ */
        #login-panel { max-width: 400px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; }
        input[type="password"] { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: var(--text); color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 1rem; margin-top: 20px; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ç·¨è¼¯å€ */
        #editor-panel { display: none; max-width: 800px; margin: 0 auto; }
        
        /* åˆ†é¡å¡ç‰‡ */
        .section-card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid transparent; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-bottom: 15px; }
        .cat-title-input { font-size: 1.2rem; font-weight: bold; border: none; background: transparent; color: var(--text); width: 70%; }
        
        /* é …ç›®åˆ—è¡¨ */
        .item-row { display: flex; flex-direction: column; gap: 8px; border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; position: relative; }
        .item-row:last-child { border-bottom: none; margin-bottom: 0; }
        
        .row-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .name-input { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; }
        
        .price-grid { display: flex; gap: 5px; }
        .price-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .price-label { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
        .price-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center; background: #FAFAFA; font-size: 0.9rem; }

        /* æŒ‰éˆ•ç¾¤ */
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; opacity: 0.6; transition: 0.2s; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }
        .btn-del { color: var(--danger); }
        .btn-move { color: var(--text); }
        
        .btn-add-item { width: 100%; padding: 10px; background: #f0f0f0; border: 1px dashed #aaa; border-radius: 8px; color: #666; cursor: pointer; margin-top: 10px; }
        .btn-add-item:hover { background: #e0e0e0; color: #333; }

        .btn-add-cat { width: 100%; padding: 15px; background: var(--bg); border: 2px dashed var(--accent); border-radius: 12px; color: var(--accent); font-weight: bold; cursor: pointer; margin-bottom: 40px; }
        
        /* æ‡¸æµ®å„²å­˜ */
        #save-btn { position: fixed; bottom: 20px; right: 20px; background: var(--text); color: white; padding: 15px 30px; border-radius: 50px; border: none; font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 999; display: flex; align-items: center; gap: 8px; }
        #save-btn:active { transform: scale(0.95); }

        details summary { cursor: pointer; list-style: none; }
        details[open] summary { margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Fairy. Lå¾Œå°ç®¡ç†ç³»çµ±</h1>
    <div class="subtitle">Fairy. L CMS</div>

    <div id="login-panel">
        <h3>ç®¡ç†è€…ç™»å…¥</h3>
        <input type="password" id="token-input" placeholder="è¼¸å…¥å¯†ç¢¼(ghp_...)">
        <button class="btn-main" onclick="login()">ç™»å…¥</button>
    </div>

    <div id="editor-panel">
        <div id="categories-area"></div>
        <button class="btn-add-cat" onclick="addCategory()">ï¼‹ æ–°å¢æœå‹™åˆ†é¡</button>
        
        <div class="subtitle">â€”â€”â€”â€” å…¶ä»–è¨­å®š â€”â€”â€”â€”</div>
        <div id="addons-area"></div>

        <button id="save-btn" onclick="saveToGithub()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒ</button>
    </div>

    <script>
        // è¨­å®š
        const REPO_CONFIG = {
            owner: 'machael090807',     
            repo: 'nail-calculator',    
            path: 'data.json'           
        };

        let currentData = null;
        let fileSha = null;
        let ghToken = null;

        // è¨˜ä½ Token
        window.onload = function() {
            const savedToken = localStorage.getItem('gh_token');
            if(savedToken) document.getElementById('token-input').value = savedToken;
        }

        // 1. ç™»å…¥
        async function login() {
            const inputToken = document.getElementById('token-input').value.trim();
            const btn = document.querySelector('#login-panel button');

            if(!inputToken) return alert("è«‹è¼¸å…¥ Token");
            btn.innerText = 'è®€å–è³‡æ–™ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    headers: { 'Authorization': `token ${inputToken}` }
                });

                if(!response.ok) throw new Error('Token ç„¡æ•ˆæˆ–é€£ç·šå¤±æ•—');

                const data = await response.json();
                fileSha = data.sha; 
                const content = decodeURIComponent(escape(window.atob(data.content)));
                currentData = JSON.parse(content);
                
                // ä¿®æ­£èˆŠè³‡æ–™çµæ§‹ (å¦‚æœæœ‰çš„è©±)
                if(!currentData.categories) currentData.categories = [];
                if(!currentData.add_ons) currentData.add_ons = [];

                ghToken = inputToken;
                localStorage.setItem('gh_token', inputToken);

                renderEditor();
                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('editor-panel').style.display = 'block';

            } catch (e) {
                alert('éŒ¯èª¤ï¼š' + e.message);
                btn.innerText = 'é©—è­‰ä¸¦ç™»å…¥';
                btn.disabled = false;
            }
        }

        // 2. æ¸²æŸ“ç·¨è¼¯å™¨ (æ ¸å¿ƒé‚è¼¯)
        function renderEditor() {
            renderCategories();
            renderAddons();
        }

        // æ¸²æŸ“åˆ†é¡å€å¡Š
        function renderCategories() {
            const container = document.getElementById('categories-area');
            container.innerHTML = '';

            currentData.categories.forEach((cat, catIdx) => {
                const card = document.createElement('div');
                card.className = 'section-card';
                
                // åˆ†é¡æ¨™é¡Œå€
                let html = `
                    <div class="section-header">
                        <input type="text" class="cat-title-input" value="${cat.title}" onchange="updateCatTitle(${catIdx}, this.value)">
                        <div>
                            <button class="btn-icon btn-move" onclick="moveCategory(${catIdx}, -1)" title="ä¸Šç§»">â¬†</button>
                            <button class="btn-icon btn-move" onclick="moveCategory(${catIdx}, 1)" title="ä¸‹ç§»">â¬‡</button>
                            <button class="btn-icon btn-del" onclick="deleteCategory(${catIdx})" title="åˆªé™¤åˆ†é¡">ğŸ—‘</button>
                        </div>
                    </div>
                    <div class="item-list">
                `;

                // é …ç›®åˆ—è¡¨
                cat.items.forEach((item, itemIdx) => {
                    const p = item.prices;
                    html += `
                        <div class="item-row">
                            <div class="row-top">
                                <input type="text" class="name-input" value="${item.name}" placeholder="é …ç›®åç¨±" 
                                    onchange="updateItemName(${catIdx}, ${itemIdx}, this.value)">
                                <div>
                                    <button class="btn-icon btn-move" onclick="moveItem(${catIdx}, ${itemIdx}, -1)">â¬†</button>
                                    <button class="btn-icon btn-move" onclick="moveItem(${catIdx}, ${itemIdx}, 1)">â¬‡</button>
                                    <button class="btn-icon btn-del" onclick="deleteItem(${catIdx}, ${itemIdx})">âœ–</button>
                                </div>
                            </div>
                            <div class="price-grid">
                                <div class="price-col">
                                    <span class="price-label">åº—é•·</span>
                                    <input type="number" class="price-input" value="${getPrice(p.manager)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'manager', this.value)">
                                </div>
                                <div class="price-col">
                                    <span class="price-label">ç¾ç”²å¸«</span>
                                    <input type="number" class="price-input" value="${getPrice(p.artist)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'artist', this.value)">
                                </div>
                                <div class="price-col">
                                    <span class="price-label">åŠ©ç†</span>
                                    <input type="number" class="price-input" value="${getPrice(p.assistant)}" onchange="updatePrice(${catIdx}, ${itemIdx}, 'assistant', this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div><button class="btn-add-item" onclick="addItem(${catIdx})">ï¼‹ æ–°å¢é …ç›®</button>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        // æ¸²æŸ“åŠ è³¼å€å¡Š (å”¯è®€æˆ–ç°¡å–®ç·¨è¼¯ï¼Œé€™è£¡åšç°¡å–®ç‰ˆ)
        function renderAddons() {
            const container = document.getElementById('addons-area');
            container.innerHTML = '';
            
            const card = document.createElement('div');
            card.className = 'section-card';
            let html = `<div class="section-header"><b>åŠ è³¼èˆ‡å»¶ç”²è¨­å®š</b></div>`;
            
            currentData.add_ons.forEach((item, idx) => {
                 let priceVal = typeof item.price === 'number' ? item.price : item.prices.manager;
                 html += `
                    <div class="item-row" style="flex-direction:row; align-items:center;">
                        <input type="text" class="name-input" value="${item.name}" disabled style="background:#eee; color:#888;">
                        <input type="number" class="price-input" style="width:80px;" value="${priceVal}" 
                            onchange="updateAddonPrice(${idx}, this.value)">
                    </div>
                 `;
            });
            html += `<p style="font-size:0.8rem; color:#888; text-align:center;">* åŠ è³¼é …ç›®çµæ§‹è¼ƒè¤‡é›œï¼Œå»ºè­°åƒ…åœ¨æ­¤ä¿®æ”¹é‡‘é¡ï¼Œè‹¥éœ€æ–°å¢è«‹è¯ç¹«å·¥ç¨‹å¸«ã€‚</p>`;
            card.innerHTML = html;
            container.appendChild(card);
        }

        // --- è³‡æ–™æ“ä½œé‚è¼¯ (CRUD) ---

        // æ–°å¢åˆ†é¡
        function addCategory() {
            currentData.categories.push({
                title: "æ–°åˆ†é¡åç¨±",
                items: []
            });
            renderCategories();
        }

        // åˆªé™¤åˆ†é¡
        function deleteCategory(idx) {
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${currentData.categories[idx].title}ã€åˆ†é¡åŠå…¶æ‰€æœ‰é …ç›®å—ï¼Ÿ`)) return;
            currentData.categories.splice(idx, 1);
            renderCategories();
        }

        // ç§»å‹•åˆ†é¡
        function moveCategory(idx, dir) {
            if (idx + dir < 0 || idx + dir >= currentData.categories.length) return;
            const temp = currentData.categories[idx];
            currentData.categories[idx] = currentData.categories[idx + dir];
            currentData.categories[idx + dir] = temp;
            renderCategories();
        }

        // æ›´æ–°åˆ†é¡æ¨™é¡Œ
        function updateCatTitle(idx, val) {
            currentData.categories[idx].title = val;
        }

        // æ–°å¢é …ç›®
        function addItem(catIdx) {
            const newId = 'item_' + new Date().getTime(); // ç”¢ç”Ÿå”¯ä¸€ID
            currentData.categories[catIdx].items.push({
                id: newId,
                name: "æ–°é …ç›®",
                prices: { manager: 0, artist: 0, assistant: 0 }
            });
            renderCategories();
        }

        // åˆªé™¤é …ç›®
        function deleteItem(catIdx, itemIdx) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
            currentData.categories[catIdx].items.splice(itemIdx, 1);
            renderCategories();
        }

        // ç§»å‹•é …ç›®
        function moveItem(catIdx, itemIdx, dir) {
            const items = currentData.categories[catIdx].items;
            if (itemIdx + dir < 0 || itemIdx + dir >= items.length) return;
            const temp = items[itemIdx];
            items[itemIdx] = items[itemIdx + dir];
            items[itemIdx + dir] = temp;
            renderCategories();
        }

        // æ›´æ–°é …ç›®åç¨±
        function updateItemName(catIdx, itemIdx, val) {
            currentData.categories[catIdx].items[itemIdx].name = val;
        }

        // æ›´æ–°åƒ¹æ ¼
        function updatePrice(catIdx, itemIdx, role, val) {
            const num = val === '' ? null : parseInt(val);
            const prices = currentData.categories[catIdx].items[itemIdx].prices;
            
            // é‚è¼¯ï¼šå¦‚æœå¾Œå°è¼¸å…¥å–®ä¸€æ•¸å­—ï¼Œå­˜æˆæ•¸å­—ï¼›å¦‚æœå‰å°éœ€è¦æ‰‹è¶³åˆ†é–‹ï¼Œé€™è£¡é è¨­éƒ½å­˜ä¸€æ¨£
            // ç‚ºäº†ä¿æŒç›¸å®¹æ€§ï¼šé€™è£¡ç°¡å–®è™•ç†ç‚ºç›´æ¥æ›´æ–°ã€‚
            // è‹¥åŸæœ¬æ˜¯é™£åˆ— [æ‰‹, è¶³]ï¼Œå‰‡æ›´æ–° [æ–°å€¼, æ–°å€¼ + å·®åƒ¹] (ä¿ç•™åƒ¹å·®)
            if (Array.isArray(prices[role])) {
                const diff = prices[role][1] - prices[role][0];
                prices[role] = [num, num + diff];
            } else {
                prices[role] = num;
            }
        }
        
        // è¼”åŠ©ï¼šè®€å–åƒ¹æ ¼ (åªé¡¯ç¤ºç¬¬ä¸€å€‹æ•¸å­—)
        function getPrice(p) {
            if(Array.isArray(p)) return p[0];
            return p;
        }

        // æ›´æ–°åŠ è³¼åƒ¹
        function updateAddonPrice(idx, val) {
            const num = parseInt(val);
            const item = currentData.add_ons[idx];
            if(typeof item.price === 'number') {
                item.price = num;
            } else {
                // å¦‚æœæ˜¯åˆ†è·ä½çš„ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå…¨éƒ¨æ›´æ–°ä¸€æ¨£
                item.prices.manager = num;
                if(item.prices.artist) item.prices.artist = num;
                if(item.prices.assistant) item.prices.assistant = num;
            }
        }

        // 3. å„²å­˜å› GitHub
        async function saveToGithub() {
            if(!confirm("ç¢ºå®šè¦å„²å­˜æ‰€æœ‰è®Šæ›´ä¸¦ç™¼å¸ƒå—ï¼Ÿ")) return;
            const btn = document.getElementById('save-btn');
            btn.innerText = 'ä¸Šå‚³ä¸­...';
            btn.disabled = true;

            const jsonString = JSON.stringify(currentData, null, 4);
            const contentEncoded = window.btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: "Update via CMS Admin",
                content: contentEncoded,
                sha: fileSha
            };

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${ghToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if(!response.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                const resData = await response.json();
                fileSha = resData.content.sha;

                alert('âœ… ç™¼å¸ƒæˆåŠŸï¼å‰å°ç´„ 1 åˆ†é˜å¾Œæ›´æ–°ã€‚');
                btn.innerText = 'ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒ';
                btn.disabled = false;
            } catch (e) {
                alert('éŒ¯èª¤ï¼š' + e.message);
                btn.innerText = 'ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒ';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
