<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairy. L å¾Œå°ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #F6F1ED; --card: #FFFFFF; --text: #4E342E; --btn: #8D7B6F; --danger: #E57373; --input-bg: #F5F5F5; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; padding: 20px; margin: 0; padding-bottom: 80px; }
        
        h1 { text-align: center; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #8D6E63; margin-bottom: 20px; font-size: 0.9rem; }

        /* åˆ†é æŒ‰éˆ• */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { flex: 1; min-width: 80px; text-align: center; padding: 10px; background: #E0D8D4; border-radius: 10px; cursor: pointer; color: #795548; font-weight: bold; white-space: nowrap; }
        .tab.active { background: var(--btn); color: white; }
        .page { display: none; }
        .page.active { display: block; }

        /* å¡ç‰‡èˆ‡è¼¸å…¥æ¡† */
        .card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        .section-header { font-size: 1.1rem; font-weight: bold; margin: 20px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        
        label { display: block; margin-top: 10px; font-size: 0.9rem; color: #8D6E63; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: none; background: var(--input-bg); border-radius: 8px; font-size: 1rem; box-sizing: border-box; color: var(--text); }
        .row { display: flex; gap: 10px; }
        .row input { flex: 1; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn-add { background: #81C784; color: white; width: 100%; margin-top: 10px; }
        .btn-del { background: transparent; color: var(--danger); border: 1px solid var(--danger); font-size: 0.8rem; position: absolute; top: 15px; right: 15px; }
        .btn-save { background: var(--btn); color: white; width: 100%; padding: 15px; font-size: 1.1rem; position: fixed; bottom: 0; left: 0; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 99; }
        .btn-load { background: #8D6E63; color: white; margin-bottom: 20px; width: 100%; }

        /* åƒ¹æ ¼è¼¸å…¥å€å¡Š */
        .price-group { background: #FAFAFA; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .price-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .price-label { width: 50px; font-size: 0.85rem; color: #999; }

        /* ç³»çµ±è¨­å®šå€ */
        .config-box { background: #3E2723; color: #D7CCC8; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .config-box input { background: #5D4037; color: white; }
        .config-box label { color: #A1887F; }
    </style>
</head>
<body>

    <h1>Fairy. L å¾Œå°</h1>
    <div class="subtitle">è¨­å®šèˆ‡åƒ¹æ ¼ç®¡ç†ç³»çµ±</div>

    <details class="config-box">
        <summary style="cursor:pointer; font-weight:bold;">âš™ï¸ GitHub é€£ç·šè¨­å®š (é»æ“Šå±•é–‹)</summary>
        <label>GitHub Token (Personal Access Token)</label>
        <input type="password" id="gh_token" placeholder="ghp_xxxx..." onchange="saveConfig()">
        <label>ä½¿ç”¨è€…åç¨± (Username)</label>
        <input type="text" id="gh_user" placeholder="machael090807" onchange="saveConfig()">
        <label>å„²å­˜åº«åç¨± (Repo)</label>
        <input type="text" id="gh_repo" placeholder="nail-calculator" onchange="saveConfig()">
        <label>æª”æ¡ˆè·¯å¾‘ (Path)</label>
        <input type="text" id="gh_path" value="data.json" readonly>
        <button class="btn-load" onclick="loadData()" style="margin-top:15px; background:#8D7B6F;">ğŸ“¥ è®€å–ç¾æœ‰è³‡æ–™</button>
    </details>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tab_settings')">å…¨åŸŸè¨­å®š</div>
        <div class="tab" onclick="switchTab('tab_categories')">æœå‹™èœå–®</div>
        <div class="tab" onclick="switchTab('tab_others')">å¸ç”² & åŠ è³¼</div>
    </div>

    <div id="tab_settings" class="page active">
        <div class="card">
            <div class="section-header">ğŸ‚ å„ªæƒ è¨­å®š</div>
            <label>ç•¶æœˆå£½æ˜ŸæŠ˜æ‰£ (0.9 = 9æŠ˜)</label>
            <input type="number" id="set_birthday" step="0.01" placeholder="0.9">
        </div>
        <div class="card">
            <div class="section-header">ğŸ“ ä½ç½®è¨­å®š</div>
            <label>æ‰‹éƒ¨é¡¯ç¤ºåç¨±</label>
            <input type="text" id="set_hand_name" placeholder="ğŸ–ï¸ æ‰‹éƒ¨">
            <label>è¶³éƒ¨é¡¯ç¤ºåç¨±</label>
            <input type="text" id="set_foot_name" placeholder="ğŸ¦¶ è¶³éƒ¨">
            <label>è¶³éƒ¨åŠ åƒ¹é‡‘é¡ ($)</label>
            <input type="number" id="set_foot_price" placeholder="200">
        </div>
    </div>

    <div id="tab_categories" class="page">
        <div id="categories_container"></div>
        <button class="btn-add" onclick="addCategory()" style="margin-bottom:30px">+ æ–°å¢æœå‹™å¤§åˆ†é¡</button>
    </div>

    <div id="tab_others" class="page">
        <div class="section-header">
            <span>ğŸ’… å¸ç”²é …ç›®</span>
            <button class="btn-add" style="width:auto; padding:5px 15px; margin:0;" onclick="addRemoval()">+ æ–°å¢</button>
        </div>
        <div id="removals_container"></div>

        <div class="section-header" style="margin-top:30px">
            <span>â• åŠ è³¼é …ç›®</span>
            <button class="btn-add" style="width:auto; padding:5px 15px; margin:0;" onclick="addAddon()">+ æ–°å¢</button>
        </div>
        <div id="addons_container"></div>
    </div>

    <button class="btn-save" onclick="saveData()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒæ›´æ–°</button>

    <script>
        // --- è³‡æ–™çµæ§‹åˆå§‹åŒ– ---
        let DATA = {
            settings: { birthday_discount: 0.9, location_hand_name: "ğŸ–ï¸ æ‰‹éƒ¨", location_foot_name: "ğŸ¦¶ è¶³éƒ¨", location_foot_surcharge: 200 },
            categories: [], removals: [], add_ons: [], sha: ""
        };

        // --- åˆå§‹åŒ–è®€å–è¨­å®š ---
        window.onload = function() {
            if(localStorage.getItem('gh_token')) document.getElementById('gh_token').value = localStorage.getItem('gh_token');
            if(localStorage.getItem('gh_user')) document.getElementById('gh_user').value = localStorage.getItem('gh_user');
            if(localStorage.getItem('gh_repo')) document.getElementById('gh_repo').value = localStorage.getItem('gh_repo');
        };

        function saveConfig() {
            localStorage.setItem('gh_token', document.getElementById('gh_token').value);
            localStorage.setItem('gh_user', document.getElementById('gh_user').value);
            localStorage.setItem('gh_repo', document.getElementById('gh_repo').value);
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å–è³‡æ–™ ---
        async function loadData() {
            const token = document.getElementById('gh_token').value;
            const user = document.getElementById('gh_user').value;
            const repo = document.getElementById('gh_repo').value;
            const path = document.getElementById('gh_path').value;

            if (!token || !user || !repo) return alert("è«‹å…ˆå¡«å¯« GitHub é€£ç·šè¨­å®šï¼");

            const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (!res.ok) throw new Error("é€£ç·šå¤±æ•—");
                const json = await res.json();
                
                // è§£ç¢¼ Base64
                const content = decodeURIComponent(escape(atob(json.content)));
                DATA = JSON.parse(content);
                DATA.sha = json.sha; // ç´€éŒ„ SHA ä»¥ä¾¿æ›´æ–°

                // ç¢ºä¿ settings å­˜åœ¨
                if (!DATA.settings) DATA.settings = {};

                renderAll();
                alert("âœ… è³‡æ–™è®€å–æˆåŠŸï¼");
            } catch (e) {
                alert("âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æˆ– Repo è¨­å®š");
                console.error(e);
            }
        }

        // --- æ¸²æŸ“ç•«é¢ (Render) ---
        function renderAll() {
            // 1. å¡«å…¥ Settings
            document.getElementById('set_birthday').value = DATA.settings.birthday_discount || 0.9;
            document.getElementById('set_hand_name').value = DATA.settings.location_hand_name || "ğŸ–ï¸ æ‰‹éƒ¨";
            document.getElementById('set_foot_name').value = DATA.settings.location_foot_name || "ğŸ¦¶ è¶³éƒ¨";
            document.getElementById('set_foot_price').value = DATA.settings.location_foot_surcharge || 200;

            // 2. æ¸²æŸ“ Categories
            const catContainer = document.getElementById('categories_container');
            catContainer.innerHTML = '';
            (DATA.categories || []).forEach((cat, cIdx) => {
                let itemsHtml = '';
                cat.items.forEach((item, iIdx) => {
                    itemsHtml += createItemHTML('cat', cIdx, iIdx, item);
                });

                const div = document.createElement('div');
                div.className = 'card';
                div.style.border = '2px solid #D7CCC8';
                div.innerHTML = `
                    <button class="btn-del" onclick="delCategory(${cIdx})">åˆªé™¤åˆ†é¡</button>
                    <label>åˆ†é¡æ¨™é¡Œ</label>
                    <input type="text" value="${cat.title}" onchange="updateCatTitle(${cIdx}, this.value)" style="font-weight:bold; color:#4E342E;">
                    <div style="margin-top:15px; padding-left:10px; border-left: 3px solid #EFEBE9;">
                        ${itemsHtml}
                        <button class="btn-add" style="background:#BCAAA4" onclick="addItem(${cIdx})">+ æ–°å¢æœå‹™é …ç›®</button>
                    </div>
                `;
                catContainer.appendChild(div);
            });

            // 3. æ¸²æŸ“ Removals
            const rmContainer = document.getElementById('removals_container');
            rmContainer.innerHTML = '';
            (DATA.removals || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = createItemHTML('rm', null, idx, item, true); // true ä»£è¡¨æ˜¯å¸ç”²(æœ‰åƒ¹æ ¼çµæ§‹)
                rmContainer.appendChild(div);
            });

            // 4. æ¸²æŸ“ Add-ons
            const addContainer = document.getElementById('addons_container');
            addContainer.innerHTML = '';
            (DATA.add_ons || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card';
                
                // åŠ è³¼çš„åƒ¹æ ¼å¯èƒ½æ˜¯å–®ä¸€æ•¸å­—ï¼Œä¹Ÿå¯èƒ½æ˜¯ç‰©ä»¶ï¼Œéœ€åˆ¤æ–·
                let priceHtml = '';
                if (item.prices && typeof item.prices === 'object') {
                   // è¤‡é›œå®šåƒ¹
                   priceHtml = getPriceInputsHTML('addon', null, idx, item.prices);
                } else {
                   // ç°¡å–®å®šåƒ¹
                   const p = item.price || 0;
                   priceHtml = `<label>å–®åƒ¹</label><input type="number" value="${p}" onchange="updateAddonSimplePrice(${idx}, this.value)">`;
                }

                div.innerHTML = `
                    <button class="btn-del" onclick="delAddon(${idx})">åˆªé™¤</button>
                    <label>é …ç›®åç¨±</label>
                    <input type="text" value="${item.name}" onchange="DATA.add_ons[${idx}].name = this.value">
                    <div class="row">
                        <div><label>å–®ä½ (å¦‚: /æŒ‡)</label><input type="text" value="${item.unit_desc||''}" onchange="DATA.add_ons[${idx}].unit_desc = this.value"></div>
                    </div>
                    ${priceHtml}
                `;
                addContainer.appendChild(div);
            });
        }

        // --- HTML ç”¢ç”Ÿå™¨ helper ---
        function createItemHTML(type, cIdx, iIdx, item, isRemoval = false) {
            // ç”¢ç”Ÿåƒ¹æ ¼è¼¸å…¥æ¡†
            let priceInputs = getPriceInputsHTML(type, cIdx, iIdx, item.prices);
            
            // åˆªé™¤æŒ‰éˆ•çš„ onclick
            let delFunc = type === 'cat' ? `delItem(${cIdx}, ${iIdx})` : `delRemoval(${iIdx})`;
            
            // æ›´æ–°åç¨±çš„ onchange
            let nameChange = type === 'cat' 
                ? `DATA.categories[${cIdx}].items[${iIdx}].name = this.value`
                : `DATA.removals[${iIdx}].name = this.value`;

            return `
                <div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; position:relative; border:1px solid #EEE;">
                    <button class="btn-del" style="top:5px; right:5px" onclick="${delFunc}">x</button>
                    <label>é …ç›®åç¨±</label>
                    <input type="text" value="${item.name}" onchange="${nameChange}">
                    ${priceInputs}
                </div>
            `;
        }

        function getPriceInputsHTML(type, cIdx, iIdx, prices) {
            // å¦‚æœ prices æ˜¯ null æˆ–æ•¸å­—ï¼Œå…ˆè½‰æˆé è¨­ç‰©ä»¶çµæ§‹æ–¹ä¾¿ç·¨è¼¯
            let p = prices;
            if (typeof p !== 'object' || p === null) {
                // å¦‚æœåŸæœ¬æ˜¯æ•¸å­—ï¼Œå°±å…¨å¡«ä¸€æ¨£ï¼Œå¦‚æœæ˜¯ null å°±å¡«ç©º
                let val = (typeof p === 'number') ? p : '';
                p = { manager: val, artist: val, assistant: val };
            }
            
            // ç”¢ç”Ÿæ›´æ–°è³‡æ–™çš„ JS å­—ä¸²
            const update = (role) => {
                if (type === 'cat') return `updatePrice('cat', ${cIdx}, ${iIdx}, '${role}', this.value)`;
                if (type === 'rm') return `updatePrice('rm', null, ${iIdx}, '${role}', this.value)`;
                if (type === 'addon') return `updatePrice('addon', null, ${iIdx}, '${role}', this.value)`;
            };

            // åˆ¤æ–·æ˜¯å¦ç‚ºé™£åˆ— (æ‰‹/è¶³åˆ†é–‹åƒ¹) -> é€™è£¡ç°¡åŒ–ï¼Œå¾Œå°çµ±ä¸€é¡¯ç¤ºå–®ä¸€è¼¸å…¥æ¡†ï¼Œè‹¥éœ€é€²éšå¯å†æ“´å……
            // ç‚ºäº†è®“éæŠ€è¡“äººå“¡å¥½æ‡‚ï¼Œé€™è£¡å‡è¨­è¼¸å…¥å–®ä¸€åƒ¹æ ¼ã€‚è‹¥åŸè³‡æ–™æ˜¯é™£åˆ—(æ‰‹è¶³ä¸åŒ)ï¼Œé¡¯ç¤ºç¬¬ä¸€å€‹å€¼ã€‚
            const val = (v) => Array.isArray(v) ? v[0] : (v === null ? '' : v);

            return `
                <div class="price-group">
                    <div class="price-row"><span class="price-label">åº—é•·</span><input type="number" placeholder="ç„¡" value="${val(p.manager)}" onchange="${update('manager')}"></div>
                    <div class="price-row"><span class="price-label">ç¾ç”²å¸«</span><input type="number" placeholder="ç„¡" value="${val(p.artist)}" onchange="${update('artist')}"></div>
                    <div class="price-row"><span class="price-label">åŠ©ç†</span><input type="number" placeholder="ç„¡" value="${val(p.assistant)}" onchange="${update('assistant')}"></div>
                </div>
            `;
        }

        // --- è³‡æ–™æ›´æ–°é‚è¼¯ ---
        function updateCatTitle(cIdx, val) { DATA.categories[cIdx].title = val; }
        
        function updatePrice(type, cIdx, iIdx, role, val) {
            let target;
            if (type === 'cat') target = DATA.categories[cIdx].items[iIdx];
            else if (type === 'rm') target = DATA.removals[iIdx];
            else if (type === 'addon') target = DATA.add_ons[iIdx];

            if (!target.prices || typeof target.prices !== 'object') {
                target.prices = { manager: null, artist: null, assistant: null };
            }
            
            // è½‰æ›æ•¸å­—ï¼Œè‹¥ç©ºç™½å‰‡ç‚º null
            let num = val === '' ? null : parseInt(val);
            target.prices[role] = num;
        }

        function updateAddonSimplePrice(idx, val) {
            DATA.add_ons[idx].price = parseInt(val) || 0;
            delete DATA.add_ons[idx].prices; // ç§»é™¤è¤‡é›œå®šåƒ¹çµæ§‹
        }

        // --- æ–°å¢ / åˆªé™¤ ---
        function addCategory() {
            DATA.categories.push({ title: "æ–°åˆ†é¡", items: [] });
            renderAll();
        }
        function delCategory(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ")) { DATA.categories.splice(idx, 1); renderAll(); }
        }
        function addItem(cIdx) {
            const id = 'item_' + Date.now();
            DATA.categories[cIdx].items.push({ id: id, name: "æ–°é …ç›®", prices: { manager:0, artist:0, assistant:0 } });
            renderAll();
        }
        function delItem(cIdx, iIdx) {
            DATA.categories[cIdx].items.splice(iIdx, 1);
            renderAll();
        }
        function addRemoval() {
            const id = 'rm_' + Date.now();
            DATA.removals.push({ id: id, name: "æ–°å¸ç”²", prices: { manager:0, artist:0, assistant:0 } });
            renderAll();
        }
        function delRemoval(idx) { DATA.removals.splice(idx, 1); renderAll(); }
        function addAddon() {
            const id = 'add_' + Date.now();
            DATA.add_ons.push({ id: id, name: "æ–°åŠ è³¼", price: 100, unit_desc: "" });
            renderAll();
        }
        function delAddon(idx) { DATA.add_ons.splice(idx, 1); renderAll(); }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå­˜æª” ---
        async function saveData() {
            // 1. æ”¶é›† Settings è³‡æ–™
            DATA.settings.birthday_discount = parseFloat(document.getElementById('set_birthday').value);
            DATA.settings.location_hand_name = document.getElementById('set_hand_name').value;
            DATA.settings.location_foot_name = document.getElementById('set_foot_name').value;
            DATA.settings.location_foot_surcharge = parseInt(document.getElementById('set_foot_price').value);

            const token = document.getElementById('gh_token').value;
            const user = document.getElementById('gh_user').value;
            const repo = document.getElementById('gh_repo').value;
            const path = document.getElementById('gh_path').value;
            
            if (!token || !user || !repo) return alert("GitHub è¨­å®šä¸å®Œæ•´");

            // è½‰æˆ JSON å­—ä¸²ï¼Œä¸¦ç·¨ç¢¼æˆ Base64 (è§£æ±ºä¸­æ–‡äº‚ç¢¼å•é¡Œ)
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));

            const body = {
                message: "Update via Admin Panel",
                content: content,
                sha: DATA.sha // å¿…é ˆå¸¶ä¸Š SHA æ‰èƒ½è¦†è“‹æª”æ¡ˆ
            };

            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    const json = await res.json();
                    DATA.sha = json.content.sha; // æ›´æ–° SHA
                    alert("âœ… å„²å­˜æˆåŠŸï¼å‰å°æ›´æ–°å¯èƒ½éœ€è¦å¹¾åˆ†é˜ã€‚");
                } else {
                    throw new Error("å„²å­˜å¤±æ•—");
                }
            } catch (e) {
                alert("âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²è·¯");
                console.error(e);
            }
        }
    </script>
</body>
</html>
