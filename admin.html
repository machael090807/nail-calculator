<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fairy. L å¾Œå°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root { 
            --bg: #F8F6F4; --card: #FFFFFF; 
            --text-main: #4E342E; --text-sub: #8D6E63;
            --primary: #5D4037; --danger: #EF5350;
            --input-bg: #F2F2F7; --radius: 16px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; padding-bottom: 100px; font-size: 16px; }

        /* --- é ‚éƒ¨å°èˆª --- */
        .app-header {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px 20px; position: sticky; top: 0; z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin: 0; }
        .btn-logout { background: #F5F5F5; border: none; padding: 8px 16px; border-radius: 20px; color: var(--text-sub); font-size: 0.9rem; font-weight: bold; cursor: pointer; }

        /* --- åˆ†é é¸å–® --- */
        .tabs-wrapper { padding: 10px 20px; background: var(--bg); position: sticky; top: 60px; z-index: 40; }
        .tabs { display: flex; background: #E0E0E0; padding: 4px; border-radius: 12px; }
        .tab { flex: 1; text-align: center; padding: 10px 0; border-radius: 9px; font-size: 0.95rem; font-weight: bold; color: #9E9E9E; cursor: pointer; transition: 0.2s; }
        .tab.active { background: var(--card); color: var(--text-main); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

        /* --- å…§å®¹å€å¡Š --- */
        .page { display: none; padding: 10px 20px; animation: fadeIn 0.3s ease; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(109, 76, 65, 0.05); position: relative; padding-top: 50px; }
        .card-inner { background: #FAFAFA; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #EEE; position: relative; padding-top: 50px; }

        /* --- è¼¸å…¥å…ƒä»¶ --- */
        label { display: block; margin-top: 10px; font-size: 0.9rem; color: var(--text-sub); font-weight: bold; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: none; background: var(--input-bg); border-radius: 10px; font-size: 1rem; color: var(--text-main); font-weight: 500; transition: 0.2s; }
        input:focus { background: #EAEAEA; }

        /* --- åƒ¹æ ¼ç¾¤çµ„ (RWD é—œéµä¿®æ­£) --- */
        .p-grp { display: flex; gap: 10px; margin-top: 10px; }
        .p-item { flex: 1; display: flex; flex-direction: column; }
        .p-lbl { font-size: 0.8rem; color: #9E9E9E; font-weight: bold; margin-bottom: 4px; margin-left: 4px; }

        /* æ‰‹æ©Ÿç‰ˆï¼šåƒ¹æ ¼ç›´å‘æ’åˆ— */
        @media (max-width: 480px) {
            .p-grp { flex-direction: column; gap: 12px; }
            .p-item { width: 100%; flex-direction: row; align-items: center; justify-content: space-between; }
            .p-lbl { margin-bottom: 0; width: 50px; font-size: 0.9rem; } /* å·¦å´æ¨™ç±¤å›ºå®šå¯¬åº¦ */
            .p-item input { flex: 1; } /* è¼¸å…¥æ¡†å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            
            .card { padding: 15px; padding-top: 50px; } /* èª¿æ•´æ‰‹æ©Ÿå…§è· */
            .card-inner { padding: 12px; padding-top: 50px; }
        }

        /* --- æ“ä½œæŒ‰éˆ• (å³ä¸Šè§’) --- */
        .actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; z-index: 5; }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; background: #F5F5F5; color: #757575; font-weight: bold; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.9); background: #E0E0E0; }
        .btn-del { background: #FFEBEE; color: var(--danger); }

        /* --- ä¸€èˆ¬æŒ‰éˆ• --- */
        .btn-add { background: var(--primary); color: white; width: 100%; margin-top: 20px; padding: 14px; border-radius: 12px; font-size: 1rem; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(93, 64, 55, 0.2); cursor: pointer; }
        .btn-act { background: #EFEBE9; color: var(--text-main); border: none; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; }

        /* --- åº•éƒ¨æµ®å‹•æ“ä½œåˆ— --- */
        .bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px 20px calc(15px + var(--safe-bottom)); box-shadow: 0 -5px 20px rgba(0,0,0,0.08); z-index: 90; display: flex; gap: 12px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .bar.show { transform: translateY(0); }
        .btn-cancel { flex: 1; background: #F5F5F5; color: #757575; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-save { flex: 2; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(93, 64, 55, 0.3); }

        /* --- ç™»å…¥é é¢ --- */
        #login_view { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; background: var(--bg); transition: 0.3s; }
        .login-card { background: white; width: 85%; max-width: 350px; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; }
        .login-title { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 25px; }
        
        .pwd-wrap { position: relative; margin-bottom: 20px; }
        .eye-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #BBB; font-size: 1.2rem; padding: 5px; }
        
        .btn-login { background: var(--primary); color: white; width: 100%; padding: 14px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.2); }
        select.form-control { width: 100%; padding: 12px; border: none; background: var(--input-bg); border-radius: 10px; font-size: 1rem; outline: none; margin-bottom: 15px; text-align: center; text-align-last: center; -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234E342E%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px center; background-size: 10px; color: var(--text-main); font-weight: 500; }

        /* ç”¢ç”Ÿå™¨ & å¿è€…æŒ‰éˆ• */
        .btn-ninja { margin-top: 50px; background: transparent; color: var(--bg); border: none; font-size: 1rem; width: 100px; height: 50px; cursor: default; }
        .btn-ninja:hover { cursor: pointer; }
        #gen_modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 200; justify-content: center; align-items: center; }
        .gen-box { background: white; padding: 30px; border-radius: 20px; width: 320px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="login_view">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="margin:0; font-size:1.8rem; color:var(--text-main);">Fairy. L</h1>
            <span style="color:var(--text-sub);">å¾Œå°ç®¡ç†ç³»çµ±</span>
        </div>
        <div class="login-card">
            <div class="login-title">ç®¡ç†è€…ç™»å…¥</div>
            <select id="user_select" class="form-control">
                <option value="" disabled selected>è®€å–ä½¿ç”¨è€…ä¸­...</option>
            </select>
            
            <div class="pwd-wrap">
                <input type="password" id="password_input" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align:center; letter-spacing:2px; padding-right: 40px;">
                <span class="eye-btn" onclick="togglePwd()">ğŸ‘ï¸</span>
            </div>

            <button class="btn-login" id="btn-login" onclick="attemptLogin()">ç™»å…¥</button>
            <div id="login_msg" style="color:#EF5350; font-size:0.9rem; margin-top:15px; height:20px; font-weight:bold;"></div>
        </div>
        <button class="btn-ninja" onclick="document.getElementById('gen_modal').style.display='flex'">â€¢</button>
    </div>

    <div id="gen_modal">
        <div class="gen-box">
            <div onclick="document.getElementById('gen_modal').style.display='none'" style="position:absolute; top:15px; right:15px; cursor:pointer; font-size:1.2rem; padding:5px;">âœ•</div>
            <h3 style="margin-top:0; text-align:center; color:var(--text-main);">ğŸ” ç”¢ç”Ÿé‡‘é‘°</h3>
            <p style="text-align:center; font-size:0.85rem; color:#999; margin-bottom:20px;">åªéœ€ Tokenï¼Œå¸³è™Ÿèˆ‡ Repo å·²å…§å»º</p>
            <label>GitHub Token</label>
            <input type="text" id="g_token" placeholder="ghp_xxxxxxxx...">
            <label>è¨­å®šå¯†ç¢¼</label>
            <input type="text" id="g_pass" placeholder="è¨­å®šä½ çš„ç™»å…¥å¯†ç¢¼">
            <button class="btn-login" style="margin-top:25px" onclick="generateCipher()">ç”¢ç”Ÿä¸¦è¤‡è£½</button>
            <div id="g_result" style="display:none; margin-top:15px; padding:10px; background:#F5F5F5; word-break:break-all; font-family:monospace; border-radius:8px; font-size:0.8rem; color:#333;"></div>
            <div id="g_msg" style="display:none; color:green; text-align:center; font-size:0.8rem; margin-top:5px;">âœ… å·²è¤‡è£½ï¼è«‹è²¼åˆ° JSON</div>
        </div>
    </div>

    <div id="admin_view" style="display:none;">
        <div class="app-header">
            <div class="app-title">å¾Œå°ç®¡ç†</div>
            <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('tab_settings')">å…¨åŸŸè¨­å®š</div>
                <div class="tab" onclick="switchTab('tab_categories')">æœå‹™èœå–®</div>
                <div class="tab" onclick="switchTab('tab_others')">å…¶ä»–é …ç›®</div>
            </div>
        </div>

        <div id="tab_settings" class="page active">
            <div class="card" style="padding-top:20px;">
                <div class="section-header">ğŸ‚ å„ªæƒ èˆ‡è¨­å®š</div>
                <label>ç•¶æœˆå£½æ˜ŸæŠ˜æ‰£ (0.9 = 9æŠ˜)</label>
                <input type="number" id="set_birthday" step="0.01" oninput="checkChanges()">
                <label>æ‰‹éƒ¨é¡¯ç¤ºåç¨±</label>
                <input type="text" id="set_hand_name" oninput="checkChanges()">
                <label>è¶³éƒ¨é¡¯ç¤ºåç¨±</label>
                <input type="text" id="set_foot_name" oninput="checkChanges()">
                <label>è¶³éƒ¨åŠ åƒ¹é‡‘é¡ ($)</label>
                <input type="number" id="set_foot_price" oninput="checkChanges()">
            </div>
        </div>

        <div id="tab_categories" class="page">
            <div id="categories_container"></div>
            <button class="btn-add" onclick="addCategory()">+ æ–°å¢æœå‹™å¤§åˆ†é¡</button>
        </div>

        <div id="tab_others" class="page">
            <div class="card">
                <div class="section-header" style="margin:0;"><span>ğŸ’… å¸ç”²é …ç›®</span><button class="btn-act" onclick="addRemoval()">æ–°å¢</button></div>
                <div id="removals_container" style="margin-top:15px;"></div>
            </div>
            <div class="card">
                <div class="section-header" style="margin:0;"><span>â• åŠ è³¼é …ç›®</span><button class="btn-act" onclick="addAddon()">æ–°å¢</button></div>
                <div id="addons_container" style="margin-top:15px;"></div>
            </div>
        </div>

        <div class="bar" id="action_bar">
            <button class="btn-cancel" onclick="cancelChanges()">å–æ¶ˆå¾©åŸ</button>
            <button class="btn-save" onclick="saveData()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè¨­å®š (è«‹ç¢ºèªä½ çš„ GitHub å¸³è™Ÿèˆ‡ Repo) ---
        const GITHUB_CONFIG = { user: "machael090807", repo: "nail-calculator", path: "data.json" };

        let DATA = { settings: {}, categories: [], removals: [], add_ons: [], sha: "" };
        let ORIGINAL_DATA_STR = "";
        let USER_LIST = [];
        let CURRENT_TOKEN = "";

        // --- åˆå§‹åŒ– & è‡ªå‹•ç™»å…¥ ---
        window.onload = async () => {
            try { USERS = await (await fetch('admin_user.json?v=' + Date.now())).json(); } catch(e){}
            el('user_list').innerHTML = USERS.map((u,i)=>`<option value="${i}">${u.name}</option>`).join('');

            // è‡ªå‹•ç™»å…¥æª¢æŸ¥
            const savedToken = localStorage.getItem('fairy_admin_token');
            if(savedToken) {
                CURRENT_TOKEN = savedToken;
                loadData(true); // true = éœé»˜ç™»å…¥
            }
        };

        const el = id => document.getElementById(id);

        function togglePwd() {
            const p = el('password_input');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        async function attemptLogin() {
            const idx = el('user_select').value;
            const pwd = el('password_input').value;
            const msg = el('login_msg');
            
            if(!pwd || idx === "") return msg.innerText = "è«‹è¼¸å…¥å¯†ç¢¼";
            
            msg.innerText = "é©—è­‰ä¸­...";
            el('btn-login').disabled = true;

            const target = USER_LIST[idx];
            // è§£å¯†å˜—è©¦
            CURRENT_TOKEN = xor_process(atob(target.cipher), pwd);
            
            // å‘¼å« GitHub API é©—è­‰ Token æ˜¯å¦çœŸçš„æœ‰æ•ˆ
            loadData(false);
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('fairy_admin_token');
                location.reload();
            }
        }

        // --- GitHub API è®€å– (åŒ…å«é©—è­‰é‚è¼¯) ---
        async function loadData(isAuto) {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${CURRENT_TOKEN}` } });

                // â˜…â˜…â˜… é—œéµéŒ¯èª¤è™•ç† â˜…â˜…â˜…
                if(res.status === 401) throw new Error("å¯†ç¢¼éŒ¯èª¤ (Token ç„¡æ•ˆ)");
                if(res.status === 404) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ (Repo è¨­å®šéŒ¯èª¤)");
                if(!res.ok) throw new Error("é€£ç·šå¤±æ•—");

                const json = await res.json();
                DATA = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                DATA.sha = json.sha;
                if (!DATA.settings) DATA.settings = {};
                ORIGINAL_DATA_STR = JSON.stringify(DATA);
                
                // ç™»å…¥æˆåŠŸï¼šå„²å­˜ Token
                localStorage.setItem('fairy_admin_token', CURRENT_TOKEN);
                
                renderAll();
                el('login_view').style.opacity = '0';
                setTimeout(() => { 
                    el('login_view').style.display = 'none'; 
                    el('admin_view').style.display = 'block'; 
                }, 300);

            } catch(e) {
                el('btn-login').disabled = false;
                if(isAuto) {
                    localStorage.removeItem('fairy_admin_token'); // Token å¤±æ•ˆå‰‡æ¸…é™¤
                } else {
                    el('login_msg').innerText = "âŒ " + e.message;
                }
            }
        }

        // --- æ¸²æŸ“ Helper ---
        function getActionsHTML(type, idx, subIdx, total) {
            let upFunc, downFunc, delFunc;
            if (type === 'cat') { upFunc=`moveCategory(${idx}, -1)`; downFunc=`moveCategory(${idx}, 1)`; delFunc=`delCategory(${idx})`; }
            else if (type === 'item') { upFunc=`moveItem(${idx}, ${subIdx}, -1)`; downFunc=`moveItem(${idx}, ${subIdx}, 1)`; delFunc=`delItem(${idx}, ${subIdx})`; }
            else if (type === 'rm') { upFunc=`moveRemoval(${idx}, -1)`; downFunc=`moveRemoval(${idx}, 1)`; delFunc=`delRemoval(${idx})`; }
            else if (type === 'addon') { upFunc=`moveAddon(${idx}, -1)`; downFunc=`moveAddon(${idx}, 1)`; delFunc=`delAddon(${idx})`; }

            const isFirst = (subIdx===null ? idx : subIdx) === 0;
            const isLast = (subIdx===null ? idx : subIdx) === total - 1;

            return `<div class="actions">
                <button class="btn-icon" style="${isFirst?'visibility:hidden':''}" onclick="${upFunc}">â†‘</button>
                <button class="btn-icon" style="${isLast?'visibility:hidden':''}" onclick="${downFunc}">â†“</button>
                <button class="btn-icon btn-del" onclick="${delFunc}">âœ•</button>
            </div>`;
        }

        function getPriceInputsHTML(type, cIdx, iIdx, prices) {
            let p = prices;
            if (typeof p !== 'object' || p === null) { let val = (typeof p === 'number') ? p : ''; p = { manager: val, artist: val, assistant: val }; }
            
            const update = (role) => {
                if (type === 'item') return `updatePrice('item', ${cIdx}, ${iIdx}, '${role}', this.value)`;
                if (type === 'rm') return `updatePrice('rm', null, ${iIdx}, '${role}', this.value)`;
                if (type === 'addon') return `updatePrice('addon', null, ${iIdx}, '${role}', this.value)`;
            };
            const val = (v) => Array.isArray(v) ? v[0] : (v === null ? '' : v);

            // æ‰‹æ©Ÿç‰ˆæœƒè‡ªå‹•è®Šæˆç›´æ’ (CSS æ§åˆ¶)
            return `<div class="p-grp">
                <div class="p-item"><span class="p-lbl">åº—é•·</span><input type="number" placeholder="ç„¡" value="${val(p.manager)}" oninput="${update('manager')}"></div>
                <div class="p-item"><span class="p-lbl">ç¾ç”²</span><input type="number" placeholder="ç„¡" value="${val(p.artist)}" oninput="${update('artist')}"></div>
                <div class="p-item"><span class="p-lbl">åŠ©ç†</span><input type="number" placeholder="ç„¡" value="${val(p.assistant)}" oninput="${update('assistant')}"></div>
            </div>`;
        }

        // --- æ¸²æŸ“ ---
        function renderAll() {
            el('set_birthday').value = DATA.settings.birthday_discount || 0.9;
            el('set_hand_name').value = DATA.settings.location_hand_name || "ğŸ–ï¸ æ‰‹éƒ¨";
            el('set_foot_name').value = DATA.settings.location_foot_name || "ğŸ¦¶ è¶³éƒ¨";
            el('set_foot_price').value = DATA.settings.location_foot_surcharge || 200;
            renderCategories(); renderRemovals(); renderAddons();
        }

        function renderCategories() {
            const container = el('categories_container');
            container.innerHTML = '';
            (DATA.categories || []).forEach((cat, cIdx) => {
                let itemsHtml = '';
                cat.items.forEach((item, iIdx) => { 
                    itemsHtml += `<div class="card-inner">
                        ${getActionsHTML('item', cIdx, iIdx, cat.items.length)}
                        <label style="margin-top:0">åç¨±</label><input type="text" value="${item.name}" oninput="DATA.categories[${cIdx}].items[${iIdx}].name=this.value; checkChanges()">
                        ${getPriceInputsHTML('item', cIdx, iIdx, item.prices)}
                    </div>`;
                });
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    ${getActionsHTML('cat', cIdx, null, DATA.categories.length)}
                    <label>åˆ†é¡æ¨™é¡Œ</label><input type="text" value="${cat.title}" oninput="DATA.categories[${cIdx}].title=this.value; checkChanges()">
                    <div style="margin-top:15px;">${itemsHtml}<button class="btn-add" style="background:#EEE; color:#333; margin-top:15px" onclick="addItem(${cIdx})">+ æ–°å¢é …ç›®</button></div>`;
                container.appendChild(div);
            });
        }

        function renderRemovals() {
            const container = el('removals_container');
            container.innerHTML = '';
            (DATA.removals || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card-inner'; div.style.marginTop="10px";
                div.innerHTML = `
                    ${getActionsHTML('rm', idx, null, DATA.removals.length)}
                    <label style="margin-top:0">åç¨±</label><input type="text" value="${item.name}" oninput="DATA.removals[${idx}].name=this.value; checkChanges()">
                    ${getPriceInputsHTML('rm', null, idx, item.prices)}`;
                container.appendChild(div);
            });
        }

        function renderAddons() {
            const container = el('addons_container');
            container.innerHTML = '';
            (DATA.add_ons || []).forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'card-inner'; div.style.marginTop="10px";
                let priceHtml = item.prices && typeof item.prices === 'object' 
                    ? getPriceInputsHTML('addon', null, idx, item.prices)
                    : `<label>å–®åƒ¹</label><input type="number" value="${item.price||0}" oninput="updateAddonSimplePrice(${idx}, this.value)">`;
                div.innerHTML = `
                    ${getActionsHTML('addon', idx, null, DATA.add_ons.length)}
                    <label style="margin-top:0">åç¨±</label><input type="text" value="${item.name}" oninput="DATA.add_ons[${idx}].name=this.value; checkChanges()">
                    <div style="display:flex; gap:10px"><div style="flex:1"><label>å–®ä½</label><input type="text" value="${item.unit_desc||''}" oninput="DATA.add_ons[${idx}].unit_desc=this.value; checkChanges()"></div></div>${priceHtml}`;
                container.appendChild(div);
            });
        }

        // --- é‚è¼¯æ“ä½œ ---
        function checkChanges() {
            DATA.settings.birthday_discount = parseFloat(el('set_birthday').value);
            DATA.settings.location_hand_name = el('set_hand_name').value;
            DATA.settings.location_foot_name = el('set_foot_name').value;
            DATA.settings.location_foot_surcharge = parseInt(el('set_foot_price').value);
            const currentStr = JSON.stringify(DATA);
            const bar = el('action_bar');
            if (currentStr !== ORIGINAL_DATA_STR) bar.classList.add('show'); else bar.classList.remove('show');
        }

        function cancelChanges() {
            if(confirm("ç¢ºå®šè¦æ”¾æ£„æ‰€æœ‰ä¿®æ”¹ï¼Œæ¢å¾©æˆåŸæœ¬çš„æ¨£å­å—ï¼Ÿ")) {
                DATA = JSON.parse(ORIGINAL_DATA_STR);
                renderAll();
                el('action_bar').classList.remove('show');
            }
        }

        function updatePrice(type, cIdx, iIdx, role, val) {
            let target;
            if (type === 'item') target = DATA.categories[cIdx].items[iIdx];
            else if (type === 'rm') target = DATA.removals[iIdx];
            else if (type === 'addon') target = DATA.add_ons[iIdx];
            if (!target.prices || typeof target.prices !== 'object') target.prices = { manager:null, artist:null, assistant:null };
            target.prices[role] = val === '' ? null : parseInt(val);
            checkChanges();
        }
        function updateAddonSimplePrice(idx, val) { DATA.add_ons[idx].price = parseInt(val) || 0; delete DATA.add_ons[idx].prices; checkChanges(); }

        // --- æ’åº & åˆªé™¤ ---
        function moveCategory(idx, dir) { swap(DATA.categories, idx, idx+dir); renderCategories(); checkChanges(); }
        function moveItem(cIdx, iIdx, dir) { swap(DATA.categories[cIdx].items, iIdx, iIdx+dir); renderCategories(); checkChanges(); }
        function moveRemoval(idx, dir) { swap(DATA.removals, idx, idx+dir); renderRemovals(); checkChanges(); }
        function moveAddon(idx, dir) { swap(DATA.add_ons, idx, idx+dir); renderAddons(); checkChanges(); }
        function swap(arr, a, b) { if(b>=0 && b<arr.length) [arr[a], arr[b]] = [arr[b], arr[a]]; }

        function delCategory(idx) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ")) { DATA.categories.splice(idx, 1); renderCategories(); checkChanges(); } }
        function delItem(cIdx, iIdx) { DATA.categories[cIdx].items.splice(iIdx, 1); renderCategories(); checkChanges(); }
        function delRemoval(idx) { DATA.removals.splice(idx, 1); renderRemovals(); checkChanges(); }
        function delAddon(idx) { DATA.add_ons.splice(idx, 1); renderAddons(); checkChanges(); }

        // --- æ–°å¢ ---
        function addCategory() { DATA.categories.push({ title: "æ–°åˆ†é¡", items: [] }); renderCategories(); checkChanges(); }
        function addItem(cIdx) { DATA.categories[cIdx].items.push({ id: 'i'+Date.now(), name: "æ–°é …ç›®", prices: { manager:0, artist:0, assistant:0 } }); renderCategories(); checkChanges(); }
        function addRemoval() { DATA.removals.push({ id: 'r'+Date.now(), name: "æ–°å¸ç”²", prices: { manager:0, artist:0, assistant:0 } }); renderRemovals(); checkChanges(); }
        function addAddon() { DATA.add_ons.push({ id: 'a'+Date.now(), name: "æ–°åŠ è³¼", price: 100 }); renderAddons(); checkChanges(); }

        // --- å„²å­˜ ---
        async function saveData() {
            const btn = document.querySelector('.btn-save');
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            
            try {
                const body = { message: "Update via Admin", content: btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2)))), sha: DATA.sha };
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${CURRENT_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) { 
                    const json = await res.json(); DATA.sha = json.content.sha; 
                    ORIGINAL_DATA_STR = JSON.stringify(DATA); el('action_bar').classList.remove('show');
                    alert("âœ… å„²å­˜æˆåŠŸï¼"); 
                } else throw new Error();
            } catch (e) { alert("âŒ å„²å­˜å¤±æ•—"); } finally { btn.innerText = originalText; }
        }

        // --- å·¥å…· ---
        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            if(id === 'settings') { el('tab_settings').classList.add('active'); document.querySelectorAll('.tab')[0].classList.add('active'); }
            if(id === 'categories') { el('tab_categories').classList.add('active'); document.querySelectorAll('.tab')[1].classList.add('active'); }
            if(id === 'others') { el('tab_others').classList.add('active'); document.querySelectorAll('.tab')[2].classList.add('active'); }
        }
        function generateCipher() {
            const t = el('g_token').value.trim();
            const p = el('g_pass').value.trim();
            if(!t || !p) return alert("è«‹å¡«å¯«è³‡æ–™");
            const c = btoa(xor_process(t, p));
            el('g_result').innerText = c; el('g_result').style.display='block';
            navigator.clipboard.writeText(c).then(() => el('g_msg').style.display='block');
        }
        function xor_process(text, key) {
            let result = '';
            for (let i = 0; i < text.length; i++) { result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
            return result;
        }
    </script>
</body>
</html>
